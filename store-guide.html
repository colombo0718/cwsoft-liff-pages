<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>é–€å¸‚å°è¦½</title>

  <!-- æ²¿ç”¨åŒä¸€å¥—é¢¨æ ¼ -->
  <link rel="stylesheet" href="./style.css" />

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    /* å°è£œå……ï¼šåˆ—è¡¨ç”¨çš„æ¨£å¼ï¼ˆä»æ²¿ç”¨ä¸»è‰²ã€åœ“è§’ã€é–“è·è®Šæ•¸ï¼‰ */
    .list{
      display:flex;
      flex-direction:column;
      gap:var(--space);
    }
    .item{
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:var(--space);
      background:var(--bg);
    }
    .item h3{
      margin:0 0 6px 0;
      font-size:18px;
    }
    .addr{
      color:var(--muted);
      font-size:15px;
      line-height:1.4;
      white-space:pre-wrap;
    }
    .row{
      display:flex;
      gap:var(--space);
      margin-top:10px;
    }
    .row button{
      flex:1 1 auto;
    }
    .topline{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:var(--space);
      margin-bottom:10px;
    }
    .badge{
      font-size:13px;
      color:var(--muted);
    }
  </style>
</head>

<body>
  <section class="card">
    <header class="topline">
      <h2 style="margin:0;">ğŸ¬ é–€å¸‚å°è¦½</h2>
      <span class="badge" id="badge"></span>
    </header>

    <p class="hint" id="hint">è®€å–ä¸­â€¦</p>
    <output id="status" aria-live="polite"></output>

    <div class="list" id="list"></div>

    <footer style="margin-top:10px;">
      <button type="button" id="btn-close" class="btn">é—œé–‰</button>
    </footer>

    <details style="margin-top:10px;">
      <summary>Debugï¼ˆå·¥ç¨‹ç”¨ï¼‰</summary>
      <pre id="debug">[debug] boot.</pre>
    </details>
  </section>

<script>
  // ===== Config =====
  const API_BIND = "https://cwsoft.leaflune.org/bind";
  const LIFF_ID_DEFAULT = "2008039127-F5GTH4WZ"; // ä½ å¯æ²¿ç”¨æ—¢æœ‰é è¨­

  // ===== DOM =====
  const $ = (id) => document.getElementById(id);
  const hintEl = $("hint");
  const statusEl = $("status");
  const listEl = $("list");
  const badgeEl = $("badge");
  const debugEl = $("debug");
  const btnClose = $("btn-close");

  function dbg(line){
    const t = new Date().toISOString().slice(11,19);
    debugEl.textContent += `\n[${t}] ${line}`;
    debugEl.scrollTop = debugEl.scrollHeight;
  }
  function setStatus(text, type){
    statusEl.className = "status" + (type ? " " + type : "");
    statusEl.textContent = text || "";
  }
  function getParam(name){
    return new URLSearchParams(location.search).get(name) || "";
  }

  function mapsUrlByAddress(addr){
    const q = encodeURIComponent(addr);
    return `https://www.google.com/maps/search/?api=1&query=${q}`;
  }

function render(items){
  listEl.innerHTML = "";
  if (!items.length){
    hintEl.textContent = "æŸ¥ç„¡å¯ç”¨é–€å¸‚ï¼ˆå¯èƒ½éƒ½å·²æ”¶åº— / ç·šä¸Šä»˜æ¬¾åœç”¨ï¼‰ã€‚";
    return;
  }
  hintEl.textContent = "è«‹é¸æ“‡é–€å¸‚ï¼š";

  for (const it of items){
    const div = document.createElement("div");
    div.className = "item item-left";   // âœ… å¤šåŠ ä¸€å€‹ class æ–¹ä¾¿å¥—æ–°æ’ç‰ˆ

    // âœ… å·¦å´æŒ‰éˆ•ï¼šğŸš—å‰å¾€
    const btnGo = document.createElement("button");
    btnGo.type = "button";
    btnGo.className = "btn-go";
    btnGo.textContent = "ğŸš—å‰å¾€";
    btnGo.addEventListener("click", () => {
      const url = mapsUrlByAddress(it.address || it.store_name || "");
      dbg(`open map: ${url}`);
      window.open(url, "_blank");
    });

    // âœ… å³å´è³‡è¨Šï¼šåº—å + åœ°å€ï¼ˆé å·¦ï¼‰
    const info = document.createElement("div");
    info.className = "info";

    const name = document.createElement("div");
    name.className = "store-name";
    name.textContent = it.store_name || "(æœªå‘½åé–€å¸‚)";

    const addr = document.createElement("div");
    addr.className = "addr";
    addr.textContent = it.address || "(æœªæä¾›åœ°å€)";

    info.appendChild(name);
    info.appendChild(addr);

    // çµ„åˆï¼šæŒ‰éˆ•åœ¨æœ€å·¦ï¼Œè³‡æ–™åœ¨å³ä½†é å·¦å°é½Š
    div.appendChild(btnGo);
    div.appendChild(info);

    listEl.appendChild(div);
  }
}

  async function fetchStores(dbName){
    const url = new URL(`${API_BIND}/branches`);
    url.searchParams.set("name", dbName);

    dbg(`fetch: ${url.toString()}`);
    const res = await fetch(url.toString(), { method:"GET", mode:"cors", cache:"no-store" });
    const data = await res.json().catch(() => ({}));

    if (!res.ok || !data?.ok){
      throw new Error(data?.error || `HTTP ${res.status}`);
    }
    return data;
  }

  async function init(){
    dbg("init start");

    // 1) db name
    const dbName = (getParam("name") || "").trim();
    badgeEl.textContent = dbName ? `db: ${dbName}` : "db: (missing)";

    if (!dbName){
      hintEl.textContent = "ç¶²å€ç¼ºå°‘ nameï¼ˆè³‡æ–™åº«åï¼‰ã€‚";
      setStatus("è«‹ä½¿ç”¨ ?name=ä¹…æ—º çš„å½¢å¼é–‹å•Ÿ", "error");
      return;
    }

    // 2) init LIFF
    const LIFF_ID = getParam("liffId") || LIFF_ID_DEFAULT;
    try{
      await liff.init({ liffId: LIFF_ID });
      dbg("LIFF ok");
    }catch(e){
      dbg(`LIFF init failed: ${e?.message || e}`);
      setStatus("LIFF åˆå§‹åŒ–å¤±æ•—", "error");
      return;
    }

    if (!liff.isLoggedIn()){
      dbg("not logged in -> login()");
      setStatus("å°šæœªç™»å…¥ Lineï¼Œæº–å‚™è·³è½‰ç™»å…¥â€¦");
      liff.login();
      return;
    }

    // 3) load stores
    try{
      setStatus("è®€å–é–€å¸‚ä¸­â€¦");
      const data = await fetchStores(dbName);
      dbg(`stores ok: count=${data.count}`);
      setStatus("");
      render(data.items || []);
    }catch(e){
      dbg(`stores failed: ${e?.message || e}`);
      setStatus(`è®€å–å¤±æ•—ï¼š${e?.message || e}`, "error");
      hintEl.textContent = "è®€å–é–€å¸‚æ¸…å–®å¤±æ•—ã€‚";
    }
  }

  btnClose.addEventListener("click", () => {
    try{
      if (window.liff && liff.isInClient()){
        liff.closeWindow();
      }else{
        window.close();
      }
    }catch(e){
      window.close();
    }
  });

  init();
</script>
</body>
</html>