<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>åŠ å…¥æœƒå“¡ï½œé€²éšè¡ŒéŠ·æ–¹æ¡ˆ Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="card">
    <div class="card-header">
      <div class="dot"></div>
      <div class="title-group">
        <h1>åŠ å…¥æœƒå“¡</h1>
        <div class="subtitle">é€²éšè¡ŒéŠ·æ–¹æ¡ˆ Â· Line å®˜æ–¹å¸³è™Ÿç¶å®š</div>
      </div>
      <div class="badge">Demo</div>
    </div>

    <div class="hint">
      é€™é å¿…é ˆé€é LIFF é–‹å•Ÿã€‚é–‹å•Ÿå¾Œæœƒè‡ªå‹•æŠ“å–ä½¿ç”¨è€… Profileï¼Œä¸¦é¡¯ç¤º LIFF userIdã€‚<br>
      ï¼ˆæ³¨æ„ï¼šé€™å€‹ userId æ˜¯ LIFF/Provider çš„ï¼Œä¸ä¸€å®šç­‰æ–¼è©² OA webhook çš„ userIdï¼‰
    </div>

    <!-- â¶ æ–°å¢ï¼šLIFF ä½¿ç”¨è€…è³‡è¨Šé¡¯ç¤ºå€ -->
    <div class="preview" id="user-box" style="margin-top:12px;">
      <div class="preview-title">ğŸ‘¤ LIFF ä½¿ç”¨è€…è³‡è¨Š</div>
      <div id="user-body">ï¼ˆå°šæœªåˆå§‹åŒ– LIFFâ€¦ï¼‰</div>
    </div>

    <form id="member-form">
      <label>
        <div class="label-main">
          æ‰‹æ©Ÿè™Ÿç¢¼ <span class="required">*</span>
        </div>
        <input id="phone" type="tel" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š0912-345-678" required />
      </label>

      <label>
        <div class="label-main">
          å§“å <span class="required">*</span>
        </div>
        <input id="name" type="text" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" required />
      </label>

      <label>
        <div class="label-main">
          é€šè¨Šåœ°å€
        </div>
        <input id="address" type="text" placeholder="ä¾‹å¦‚ï¼šå°å—å¸‚æ±å€æˆåŠŸè·¯ 123 è™Ÿ" />
      </label>

      <label>
        <div class="label-main">
          å‚™è¨»
        </div>
        <textarea id="note" placeholder="ä¾‹å¦‚ï¼šå¸¸ç”¨åˆ†åº—ã€ç‰¹æ®Šéœ€æ±‚ã€ç”Ÿæ—¥ç­‰â€¦"></textarea>
      </label>

      <button type="submit" class="btn">
        <span class="icon">âœ…</span>
        <span>é€å‡ºï¼Œå¯«å…¥ Line è¨Šæ¯</span>
      </button>
    </form>

    <div class="status" id="status"></div>

    <div class="preview" id="preview">
      <div class="preview-title">ğŸ“¨ é è¦½ï¼šé€åˆ° Line å°è©±çš„å…§å®¹</div>
      <div id="preview-body">ï¼ˆè«‹å…ˆè¼¸å…¥ä¸Šæ–¹è³‡æ–™â€¦ï¼‰</div>
    </div>

    <div class="env-warning" id="env-warning">
      âš ï¸ åµæ¸¬ä¸åˆ° LIFF ç’°å¢ƒæˆ–ä¸åœ¨ Line å…§é–‹å•Ÿã€‚<br>
      è«‹å¾ Line OA çš„ LIFF å…¥å£é–‹å•Ÿï¼Œæ‰èƒ½æŠ“åˆ° userId èˆ‡é€è¨Šæ¯ã€‚
    </div>
  </div>

  <script>
    const LIFF_ID = "2008039127-p7We0QWm"; // æ›æˆä½ çš„ LIFF ID

    const phoneInput = document.getElementById("phone");
    const nameInput = document.getElementById("name");
    const addressInput = document.getElementById("address");
    const noteInput = document.getElementById("note");
    const statusEl = document.getElementById("status");
    const previewBodyEl = document.getElementById("preview-body");
    const envWarningEl = document.getElementById("env-warning");
    const userBodyEl = document.getElementById("user-body");
    const form = document.getElementById("member-form");

    let liffReady = false;
    let liffProfile = null; // æœƒå­˜ { userId, displayName, pictureUrl, statusMessage }

    function escapeHtml(s) {
      return (s ?? "").toString()
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function buildMessageText() {
      const phone = phoneInput.value.trim();
      const name = nameInput.value.trim();
      const address = addressInput.value.trim();
      const note = noteInput.value.trim();

      let lines = [];
      lines.push("GTB|BIND_MEMBER|v=1");
      if (liffProfile?.userId) lines.push("LIFF_userIdï¼š" + liffProfile.userId); // æ–¹ä¾¿ä½ åœ¨ webhook çœ‹åˆ°
      if (name)   lines.push("å§“åï¼š" + name);
      if (phone)  lines.push("æ‰‹æ©Ÿï¼š" + phone);
      if (address) lines.push("åœ°å€ï¼š" + address);
      if (note)   lines.push("å‚™è¨»ï¼š" + note);

      return lines.join("\n");
    }

    function updatePreview() {
      const text = buildMessageText();
      previewBodyEl.textContent = text || "ï¼ˆè«‹å…ˆè¼¸å…¥ä¸Šæ–¹è³‡æ–™â€¦ï¼‰";
    }

    phoneInput.addEventListener("input", updatePreview);
    nameInput.addEventListener("input", updatePreview);
    addressInput.addEventListener("input", updatePreview);
    noteInput.addEventListener("input", updatePreview);

    function renderUserBox(profile, extra = {}) {
      const rows = [];

      rows.push(`<div>âœ… LIFF å·²åˆå§‹åŒ–ï¼š<b>${liffReady ? "æ˜¯" : "å¦"}</b></div>`);
      rows.push(`<div>ğŸ“± isInClientï¼š<b>${window.liff?.isInClient?.() ? "æ˜¯" : "å¦"}</b></div>`);
      rows.push(`<div>ğŸ” isLoggedInï¼š<b>${window.liff?.isLoggedIn?.() ? "æ˜¯" : "å¦"}</b></div>`);

      if (profile) {
        rows.push("<hr style='opacity:.15;margin:10px 0;'>");
        rows.push(`<div>userIdï¼š<code>${escapeHtml(profile.userId)}</code></div>`);
        rows.push(`<div>displayNameï¼š<b>${escapeHtml(profile.displayName)}</b></div>`);
        rows.push(`<div>statusMessageï¼š${escapeHtml(profile.statusMessage || "ï¼ˆç©ºï¼‰")}</div>`);
        if (profile.pictureUrl) {
          rows.push(`<div style="margin-top:8px;"><img src="${escapeHtml(profile.pictureUrl)}" alt="avatar" style="width:64px;height:64px;border-radius:12px;object-fit:cover;"></div>`);
        }
      }

      if (extra.idTokenSub) {
        rows.push("<hr style='opacity:.15;margin:10px 0;'>");
        rows.push(`<div>ID Token subï¼š<code>${escapeHtml(extra.idTokenSub)}</code></div>`);
      }

      userBodyEl.innerHTML = rows.join("");
    }

    async function initLiff() {
      if (!window.liff) {
        envWarningEl.style.display = "block";
        userBodyEl.textContent = "ï¼ˆæ‰¾ä¸åˆ° LIFF SDKï¼‰";
        return;
      }

      try {
        await liff.init({ liffId: LIFF_ID });
        liffReady = true;

        // å¦‚æœä¸æ˜¯åœ¨ LINE å…§ï¼Œä»å¯é¡¯ç¤ºç‹€æ…‹ï¼Œä½†æŠ“ profile å¯èƒ½éœ€è¦ç™»å…¥
        if (!liff.isInClient()) {
          envWarningEl.style.display = "block";
        }

        // å¦‚æœå°šæœªç™»å…¥ï¼ˆå¤–éƒ¨ç€è¦½å™¨å¸¸è¦‹ï¼‰ï¼Œè‡ªå‹•å°å»ç™»å…¥
        if (!liff.isLoggedIn()) {
          renderUserBox(null);
          // è®“ä½ çœ‹å¾—åˆ°æç¤ºï¼Œå†è‡ªå‹• login
          statusEl.textContent = "å°šæœªç™»å…¥ LINEï¼ˆå¤–éƒ¨ç€è¦½å™¨å¸¸è¦‹ï¼‰ï¼Œå³å°‡å°å‘ç™»å…¥â€¦";
          statusEl.className = "status";
          liff.login(); // æœƒé‡å°å›æ­¤é 
          return;
        }

        // å–å¾— profile
        liffProfile = await liff.getProfile();

        // é¡å¤–ï¼šå– ID token çš„ subï¼ˆæœ‰äº›æƒ…å¢ƒæ‹¿å¾—åˆ°ï¼‰
        let idTokenSub = "";
        try {
          const decoded = liff.getDecodedIDToken?.();
          idTokenSub = decoded?.sub || "";
        } catch (_) {}

        renderUserBox(liffProfile, { idTokenSub });
        updatePreview();

        statusEl.textContent = "LIFF åˆå§‹åŒ–å®Œæˆï¼Œå·²å–å¾—ä½¿ç”¨è€…è³‡è¨Šã€‚";
        statusEl.className = "status success";
      } catch (err) {
        console.error("LIFF åˆå§‹åŒ–å¤±æ•—ï¼š", err);
        statusEl.textContent = "LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ LIFF ID æˆ– LIFF è¨­å®šã€‚";
        statusEl.className = "status error";
        envWarningEl.style.display = "block";
        renderUserBox(null);
      }
    }

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      statusEl.textContent = "";
      statusEl.className = "status";

      const phone = phoneInput.value.trim();
      const name = nameInput.value.trim();

      if (!phone || !name) {
        statusEl.textContent = "è«‹è‡³å°‘å¡«å¯«ã€Œå§“åã€èˆ‡ã€Œæ‰‹æ©Ÿè™Ÿç¢¼ã€ã€‚";
        statusEl.className = "status error";
        return;
      }

      const text = buildMessageText();
      updatePreview();

      if (!liffReady || !liff.isInClient()) {
        statusEl.textContent = "Demo æ¨¡å¼ï¼šç›®å‰ä¸åœ¨ Line å…§é–‹å•Ÿï¼Œç„¡æ³•çœŸçš„é€è¨Šæ¯ï¼ˆä½†å·²é¡¯ç¤º userId/é è¦½ï¼‰ã€‚";
        statusEl.className = "status success";
        return;
      }

      try {
        await liff.sendMessages([{ type: "text", text }]);
        statusEl.textContent = "å·²é€å‡ºè¨Šæ¯åˆ° Line å°è©±è¦–çª—ï¼ˆå« LIFF userId æ–¹ä¾¿å¾Œç«¯å°ç…§ï¼‰ã€‚";
        statusEl.className = "status success";
      } catch (err) {
        console.error("é€è¨Šæ¯å¤±æ•—ï¼š", err);
        statusEl.textContent = "é€è¨Šæ¯å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
        statusEl.className = "status error";
      }
    });

    // åˆå§‹åŒ–
    updatePreview();
    initLiff();
  </script>
</body>
</html>
