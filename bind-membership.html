<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç¶å®šæœƒå“¡</title>

  <!-- ä½ å·²ç§»é™¤ <style>ï¼šåªç”¨å¤–éƒ¨ CSS -->
  <link rel="stylesheet" href="./style.css" />

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>  
  <div class="card">  
        <h1>ç¶å®šæœƒå“¡</h1>
    <form id="member-form" autocomplete="off">
      <!-- åŸºæœ¬è³‡æ–™ -->
      <div class="block">
        <div class="block-title">ğŸ‘¤ åŸºæœ¬è³‡æ–™</div>
        <div class="hint">
          è«‹å¡«å¯«æœƒå“¡è³‡æ–™ã€‚<br />
        </div>
        <label>
          <div class="label-main req">å§“å* </div>
          <input id="name" type="text" placeholder="ä¾‹å¦‚ï¼šè¶™å£«è±ª" />
        </label>

        <label>
          <div class="label-main req">æ‰‹æ©Ÿ* </div>
          <input id="phone" type="tel" placeholder="ä¾‹å¦‚ï¼š0912-345-678" />
        </label>

        <!-- <label>
          <div class="label-main">é€šè¨Šåœ°å€</div>
          <input id="address" type="text" placeholder="ä¾‹å¦‚ï¼šå°å—å¸‚æ±å€æˆåŠŸè·¯ 123 è™Ÿ" />
        </label> -->
        <label>
          <div class="label-main">åœ°å€</div>

          <div style="margin-top:8px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <select id="addrCity" style="flex:1; min-width:100px;">
              <option value="">é¸æ“‡ç¸£å¸‚</option>
            </select>

            <select id="addrDistrict" style="flex:1; min-width:100px;" disabled>
              <option value="">å…ˆé¸ç¸£å¸‚</option>
            </select>
          </div>
        
          <!-- å…ˆæ±‚æœ‰ï¼šæŠŠé¸åˆ°çš„å€¼ä¸²æˆä¸€æ®µï¼ˆä¹‹å¾Œè¦é€å¾Œç«¯/å›å¯« DB å†ç”¨ï¼‰ -->
          <input id="address" type="hidden" value="" />
        </label>
      </div>


      <div class="block"> 
        <!-- CAPTCHA -->
        <div class="block-title">ğŸ›¡ï¸ å®‰å…¨é©—è­‰</div>
        <div class="section">
                  <div class="hint">
          è«‹å¡«å®Œæˆå®‰å…¨é©—è­‰<br />
        </div>

          <div class="captchaBox" style="margin-top:10px;">
            <button type="button" class="btn small" id="btn-captcha-refresh">âŸ³</button>
            <canvas id="captchaCanvas" width="170" height="50"></canvas>
            <input id="captchaInput"
                  type="text"
                  inputmode="numeric"
                  placeholder="è¼¸å…¥å·¦å´åœ–ç‰‡æ•¸å­—"
                  maxlength="4"
                  style="flex:1; min-width:180px;" />
          </div>

          <!-- é€™è¡Œç”¨ inline flexï¼Œé¿å…ä¾è³´ .row -->
          <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">

            <button type="button" class="btn small" id="btn-captcha-verify">é©—è­‰åœ–ç‰‡ç¢¼</button>
            <!-- <span id="captchaVerifyStatus"
                  style="font-size:12px; color:var(--muted); min-width:90px;">å°šæœªé©—è­‰</span> -->
          </div>
        </div>

        <!-- OTP -->
        <div class="section">
          <!-- <div class="mini">ğŸ“² OTP ç°¡è¨Šé©—è­‰</div>
          <div class="mini">
            é»ã€Œå–å¾— OTPã€æœƒå‘¼å«å¾Œç«¯ /otp ç™¼é€ç°¡è¨Šï¼ˆç›®å‰å…ˆæ±‚æœ‰ï¼šverify å…ˆç”¨æ ¼å¼åˆ¤æ–·ï¼‰ã€‚
          </div> -->

          <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <button type="button" class="btn small" id="btn-otp-send">å–å¾—ç°¡è¨Šé©—è­‰ç¢¼</button>
            <!-- <span id="otpSendStatus" style="font-size:12px; color:var(--muted); min-width:120px;">å°šæœªç™¼é€</span> -->
          </div>

          <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <input id="otpInput"
                  type="text"
                  inputmode="numeric"
                  placeholder="è¼¸å…¥ 6 ä½ OTP"
                  maxlength="6"
                  style="flex:1; min-width:180px;" />
            <button type="button" class="btn small" id="btn-otp-verify">é©—è­‰ OTP</button>
            <span id="otpVerifyStatus" style="font-size:12px; color:var(--muted); min-width:90px;">å°šæœªé©—è­‰</span>
          </div>
        </div>
      </div>

      <!-- é€å‡º -->
      <div class="section">
        <button type="submit" class="btn" id="btn-submit" disabled>
          <span>é€å‡ºè³‡æ–™</span>
        </button>

        <!-- é€™è£¡åªæ”¾ã€Œé é¢ç´šã€è¨Šæ¯ï¼šLIFF/ç¶å®šé–å®š/å¾Œç«¯éŒ¯èª¤ï¼Œä¸æ”¾å„æŒ‰éˆ•çµæœ -->
        <div class="status" id="status"></div>
      </div>

      <!-- Debug terminalï¼šå·¥ç¨‹ç”¨ -->
      <div class="section">
        <div class="mini">Debugï¼ˆå·¥ç¨‹ç”¨ï¼‰</div>
        <pre id="debug"
             style="margin:8px 0 0; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.18); max-height:180px; overflow:auto;"
        >[debug] boot...</pre>
      </div>
    </form>
  </div>
  <script src="./core.js"></script>
  <script src="./captcha.js"></script>
  <script>
    // ====== Config ======
    const LIFF_ID = "2008039127-VV7xY5jY"; // ä½ çš„ LIFF ID
    
    const API_OTP       = "https://cwsoft.leaflune.org/otp";
    const API_BIND      = "https://cwsoft.leaflune.org/bind";

    // å…ˆæ±‚æœ‰ï¼šä½ ä¹‹å¾Œæœƒæ›æˆå¾Œç«¯çš„ä¸€æ¬¡æ€§ token
    let checkToken = "DUMMY_TOKEN";


    // ====== Main init ======
    async function initAll() {
      dbg("init start");

      // 1) oaid
      oaid = getOaIdFromUrl();
      dbg(`oaid=${oaid || "(empty)"}`);

      // 2) lookup db
      await lookupDbNameByOaId(oaid);

      // 3) init LIFF
      try {
        await liff.init({ liffId: LIFF_ID });
        liffReady = true;
        dbg("LIFFï¼šå·²åˆå§‹åŒ–");
      } catch (e) {
        dbg(`LIFF init failed: ${e?.message || e}`);
        setStatus("LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¢ºèª LIFF ID/ç¶²è·¯ç‹€æ…‹", "error");
        refreshSubmitState();
        return;
      }

      // 4) login check
      if (!liff.isLoggedIn()) {
        dbg("Lineï¼šæœªç™»å…¥ -> redirect login");
        setStatus("å°šæœªç™»å…¥ Lineï¼Œæº–å‚™è·³è½‰ç™»å…¥â€¦");
        liff.login();
        return;
      }
      dbg("Lineï¼šå·²ç™»å…¥");

      // 5) get profile
      try {
        liffProfile = await liff.getProfile();
        dbg(`profile ok: displayName=${liffProfile.displayName}, uid=${liffProfile.userId}`);
        autofillNameFromLineProfile();
        refreshSubmitState(); // å¡«å…¥å¾Œé †ä¾¿æ›´æ–°é€å‡ºæŒ‰éˆ•ç‹€æ…‹
      } catch (e) {
        dbg(`getProfile failed: ${e?.message || e}`);
        setStatus("å–å¾—ä½¿ç”¨è€…è³‡è¨Šå¤±æ•—", "error");
        refreshSubmitState();
        return;
      }

      // 6) check bind
      try {
        const data = await checkIsBindMember(oaid, liffProfile.userId);
        if (!data.ok) throw new Error(data.error || "is_bind not ok");

        isBound = !!data.is_bound;
        memberNo = data.member_no ?? null;
        bindId = data.bind_id ?? null;

        if (isBound) {
          dbg(`Bindï¼šå·²ç¶å®š (member_no=${memberNo ?? "null"}, bind_id=${bindId ?? "null"})`);
          setStatus("æ­¤å¸³è™Ÿå·²ç¶å®šæœƒå“¡ï¼Œè¡¨å–®å·²é–å®šã€‚", "success");
          lockAllUI();
        } else {
          dbg("Bindï¼šæœªç¶å®š");
          setStatus("");
        }
      } catch (e) {
        dbg(`is_bind failed: ${e?.message || e}`);
        setStatus("æŸ¥è©¢ç¶å®šç‹€æ…‹å¤±æ•—ï¼ˆè«‹ç¨å¾Œé‡è©¦ï¼‰", "error");
      }

      // 7) init captcha/otp
      resetCaptcha();
      resetOtp();
      initAddressDropdown(); // åœ°å€ä¸‹æ‹‰é¸å–®åˆå§‹åŒ–

      // 8) wire input events
      [nameInput, phoneInput].forEach(el => el.addEventListener("input", refreshSubmitState));
      captchaInput.addEventListener("input", refreshSubmitState);
      otpInput.addEventListener("input", refreshSubmitState);

      refreshSubmitState();
      dbg("init done");
    }

    // ====== Events ======
    btnCaptchaRefresh.addEventListener("click", () => resetCaptcha());

    btnCaptchaVerify.addEventListener("click", () => {
      const v = (captchaInput.value || "").trim();
      if (v === captchaCode) {
        captchaVerified = true;
        dbg("CAPTCHAï¼šé©—è­‰æˆåŠŸ");
        // setInline(captchaVerifyStatus, "é©—è­‰æˆåŠŸ", "ok");
      } else {
        captchaVerified = false;
        dbg(`CAPTCHAï¼šé©—è­‰å¤±æ•— (input=${v || "empty"})`);
        // setInline(captchaVerifyStatus, "é©—è­‰å¤±æ•—", "bad");
        // å¯é¸ï¼šå¤±æ•—å°±æ›ä¸€å¼µï¼Œé™ä½æš´åŠ›å˜—è©¦
        resetCaptcha();
      }
      refreshSubmitState();
    });

btnOtpSend.addEventListener("click", async () => {
  // setInline(otpSendStatus, "ç™¼é€ä¸­â€¦", "");
  dbg("OTPï¼šsend request...");

  const lineOAID = (oaid || "").trim();
  const phone = normalizePhone(phoneInput.value);
  const db_name = (dbName || "").trim();   // âœ… æ–°å¢

  try {
    const url = new URL(`${API_OTP}/send`);
    url.searchParams.set("lineOAID", lineOAID);
    url.searchParams.set("phone", phone);
    url.searchParams.set("db_name", db_name); // âœ… æ–°å¢

    const res = await fetch(url.toString(), {
      method: "GET",
      mode: "cors",
      cache: "no-store",
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();
    console.log("otp send resp:", data);

    setInline(otpSendStatus, "å·²ç™¼é€ï¼ˆå…ˆæ±‚æœ‰ï¼‰", "ok");
    dbg("OTPï¼šsend ok");
  } catch (e) {
    setInline(otpSendStatus, "ç™¼é€å¤±æ•—", "bad");
    dbg(`OTPï¼šsend failed: ${e?.message || e}`);
  }
});

    btnOtpVerify.addEventListener("click", async () => {
      const v = (otpInput.value || "").trim();
      const phone = normalizePhone(phoneInput.value);

      // å…ˆåšåŸºæœ¬æ ¼å¼æª¢æŸ¥
      if (!/^\d{6}$/.test(v)) {
        otpVerified = false;
        setInline(otpVerifyStatus, "é©—è­‰å¤±æ•—ï¼šéœ€ 6 ä½æ•¸å­—", "bad");
        dbg("OTPï¼šverify failed (need 6 digits)");
        refreshSubmitState();
        return;
      }
      if (!phone) {
        otpVerified = false;
        setInline(otpVerifyStatus, "é©—è­‰å¤±æ•—ï¼šè«‹å…ˆå¡«æ‰‹æ©Ÿè™Ÿç¢¼", "bad");
        dbg("OTPï¼šverify failed (no phone)");
        refreshSubmitState();
        return;
      }

      try {
        setInline(otpVerifyStatus, "é©—è­‰ä¸­â€¦", "");
        dbg("OTPï¼šcheck request...");

        // GET + query string
        const url = new URL(`${API_OTP}/check`);
        url.searchParams.set("phone", phone);
        url.searchParams.set("otp", v);

        const res = await fetch(url.toString(), {
          method: "GET",
          mode: "cors",
          cache: "no-store",
        });

        const data = await res.json().catch(() => ({}));
        dbg("OTPï¼šcheck resp:");
        dbg(JSON.stringify(data));

        if (!res.ok || !data?.ok) {
          otpVerified = false;

          // ä¾å¾Œç«¯ error é¡å‹é¡¯ç¤ºè¨Šæ¯ï¼ˆå…ˆæ±‚æœ‰ï¼‰
          const err = data?.error || `HTTP ${res.status}`;
          if (err.includes("expired")) {
            setInline(otpVerifyStatus, "é©—è­‰å¤±æ•—ï¼šé©—è­‰ç¢¼å·²éæœŸï¼Œè«‹é‡æ–°å–å¾—", "bad");
          } else if (err.includes("mismatch")) {
            setInline(otpVerifyStatus, "é©—è­‰å¤±æ•—ï¼šé©—è­‰ç¢¼ä¸æ­£ç¢º", "bad");
          } else if (err.includes("no otp record")) {
            setInline(otpVerifyStatus, "é©—è­‰å¤±æ•—ï¼šè«‹å…ˆå–å¾—é©—è­‰ç¢¼", "bad");
          } else {
            setInline(otpVerifyStatus, "é©—è­‰å¤±æ•—", "bad");
          }

          dbg(`OTPï¼šverify failed: ${err}`);
        } else {
          // âœ… æˆåŠŸï¼šæ‹¿åˆ° check_tokenï¼Œç•¶æˆ checkToken
          checkToken = data.check_token || "";
          otpVerified = !!checkToken;

          if (otpVerified) {
            setInline(otpVerifyStatus, "é©—è­‰æˆåŠŸ", "ok");
            dbg("OTPï¼šverify ok (backend check_token received)");
          } else {
            // ç†è«–ä¸Šä¸è©²ç™¼ç”Ÿ
            setInline(otpVerifyStatus, "é©—è­‰å¤±æ•—ï¼šæœªå–å¾— token", "bad");
            dbg("OTPï¼šverify failed (no check_token)");
          }
        }
      } catch (e) {
        otpVerified = false;
        setInline(otpVerifyStatus, "é©—è­‰å¤±æ•—ï¼šç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤", "bad");
        dbg(`OTPï¼šcheck failed: ${e?.message || e}`);
      }

      refreshSubmitState();
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!canSubmit()) {
        dbg("submit blocked: canSubmit=false");
        setStatus("æ¢ä»¶å°šæœªå®Œæˆï¼Œç„¡æ³•é€å‡ºã€‚", "error");
        return;
      }

      // åªé€å››å€‹é‡è¦åƒæ•¸ + check_tokenï¼ˆå…ˆæ±‚æœ‰ï¼‰
      const payload4 = {
        lineOAID: oaid,
        lineUid: liffProfile?.userId || "",
        name: nameInput.value.trim(),
        phone: normalizePhone(phoneInput.value),
        check_token: checkToken || "",
      };

      if (!payload4.check_token) {
        dbg("submit blocked: missing check_token");
        setStatus("è«‹å…ˆå®Œæˆ OTP é©—è­‰", "error");
        return;
      }

      // GETï¼šæ”¹ç”¨ query string
      const url = new URL(`${API_BIND}/submit`);
      url.searchParams.set("lineOAID", payload4.lineOAID);
      url.searchParams.set("lineUid", payload4.lineUid);
      url.searchParams.set("name", payload4.name);
      url.searchParams.set("phone", payload4.phone);
      url.searchParams.set("check_token", payload4.check_token);

      try {
        setStatus("é€å‡ºä¸­â€¦", "");

        // GETï¼šæ”¹ç”¨ query string
        // const url = new URL(`${API_BIND}/submit`); // ä¾‹ï¼šhttps://cwsoft.leaflune.org/bind/submit
        // url.searchParams.set("lineOAID", payload4.lineOAID);
        // url.searchParams.set("lineUid", payload4.lineUid);
        // url.searchParams.set("name", payload4.name);
        // url.searchParams.set("phone", payload4.phone);

        const res = await fetch(url.toString(), {
          method: "GET",
          mode: "cors",
          cache: "no-store",
        });

        // å¾Œç«¯å› json çš„è©±å°±è®€å‡ºä¾†æ–¹ä¾¿ debug
        const data = await res.json().catch(() => null);

        if (!res.ok) {
          dbg("bind failed resp:");
          dbg(JSON.stringify(data));
          throw new Error(`HTTP ${res.status}`);
        }

        dbg("bind ok resp:");
        dbg(JSON.stringify(data));
        setStatus("ç¶å®šé€å‡ºæˆåŠŸï¼ˆå…ˆæ±‚æœ‰ï¼‰", "ok");
      } catch (err) {
        setStatus(`ç¶å®šé€å‡ºå¤±æ•—ï¼š${err?.message || err}`, "error");
      }
    });

    // Boot
    initAll();
  </script>
</body>
</html>
