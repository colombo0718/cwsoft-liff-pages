<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç¶å®šæœƒå“¡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="style.css">
  <style>
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.15); font-size:13px; opacity:.95; }
    .pill.ok { background: rgba(46, 204, 113, .18); border-color: rgba(46,204,113,.35); }
    .pill.bad { background: rgba(231, 76, 60, .18); border-color: rgba(231,76,60,.35); }
    .mini { font-size:12px; opacity:.8; line-height:1.4; }
    .section { margin-top:14px; padding-top:14px; border-top:1px solid rgba(255,255,255,.08); }
    .btn.small { padding:10px 12px; border-radius:12px; font-size:14px; }
    .captchaBox { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    canvas { border-radius:12px; border:1px solid rgba(255,255,255,.15); background: rgba(0,0,0,.15); }
    input[disabled], button[disabled] { opacity:.5; filter:grayscale(.2); cursor:not-allowed; }
    code { word-break: break-all; }
  </style>
</head>

<body>
  <div class="card">
    <div class="card-header">
      <div class="dot"></div>
      <div class="title-group">
        <h1>ç¶å®šæœƒå“¡</h1>
        <div class="subtitle">Line å®˜æ–¹å¸³è™Ÿç¶å®š</div>
      </div>
      <div class="badge">Demo</div>
    </div>

    <!-- LIFF ç‹€æ…‹ + ä½¿ç”¨è€…è³‡è¨Š -->
    <div class="preview" style="margin-top:12px;">
      <div class="preview-title">ğŸ‘¤ ä½¿ç”¨è€…è³‡è¨Š</div>

      <div class="row" style="margin:8px 0 10px;">
        <span class="pill" id="pill-liff">LIFFï¼šåˆå§‹åŒ–ä¸­â€¦</span>
        <span class="pill" id="pill-client">Clientï¼šåˆ¤æ–·ä¸­â€¦</span>
        <span class="pill" id="pill-login">Loginï¼šåˆ¤æ–·ä¸­â€¦</span>
      </div>

      <div id="user-body" class="mini">ï¼ˆå°šæœªå–å¾—ä½¿ç”¨è€…è³‡æ–™ï¼‰</div>
    </div>

    <!-- è¡¨å–®ï¼šå§“å â†’ é›»è©± â†’ åœ°å€ -->
    <form id="member-form" class="section">
      <label>
        <div class="label-main">å§“å <span class="required">*</span></div>
        <input id="name" type="text" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" required />
      </label>

      <label>
        <div class="label-main">æ‰‹æ©Ÿè™Ÿç¢¼ <span class="required">*</span></div>
        <input id="phone" type="tel" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š0912-345-678" required />
      </label>

      <label>
        <div class="label-main">é€šè¨Šåœ°å€</div>
        <input id="address" type="text" placeholder="ä¾‹å¦‚ï¼šå°å—å¸‚æ±å€æˆåŠŸè·¯ 123 è™Ÿ" />
      </label>

      <!-- é˜²æ©Ÿå™¨äººé©—è­‰ -->
      <div class="section">
        <div class="label-main">ğŸ›¡ï¸ é˜²æ©Ÿå™¨äººé©—è­‰</div>
        <div class="mini" style="margin:6px 0 10px;">è«‹è¼¸å…¥åœ–ç‰‡ä¸­çš„ 4 ä½æ•¸å­—ï¼ˆå…ˆæ±‚æœ‰ç‰ˆï¼šå‰ç«¯éš¨æ©Ÿç”¢ç”Ÿï¼‰</div>

        <div class="captchaBox">
          <canvas id="captchaCanvas" width="160" height="56" aria-label="captcha"></canvas>
          <button type="button" class="btn small" id="btn-captcha-refresh">æ›ä¸€å¼µ</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <input id="captchaInput" type="text" inputmode="numeric" maxlength="4" placeholder="è¼¸å…¥å››ä½æ•¸å­—" style="flex:1; min-width:160px;">
          <button type="button" class="btn small" id="btn-captcha-verify">é©—è­‰</button>
          <span class="pill bad" id="pill-captcha">å°šæœªé©—è­‰</span>
        </div>
      </div>

      <!-- OTP ç°¡è¨Šé©—è­‰ -->
      <div class="section">
        <div class="label-main">ğŸ“± OTP ç°¡è¨Šé©—è­‰</div>
        <div class="mini" style="margin:6px 0 10px;">é»ã€Œå–å¾—é©—è­‰ç¢¼ã€æœƒå‘¼å«å¾Œç«¯ /otp ç™¼é€ç°¡è¨Šï¼ˆç›®å‰ä¸åš verifyï¼‰</div>

        <div class="row" style="margin-bottom:10px;">
          <button type="button" class="btn small" id="btn-otp-send">å–å¾—é©—è­‰ç¢¼</button>
          <span class="pill bad" id="pill-otp-send">å°šæœªç™¼é€</span>
        </div>

        <div class="row">
          <input id="otpInput" type="text" inputmode="numeric" maxlength="6" placeholder="è¼¸å…¥ 6 ä½ OTP" style="flex:1; min-width:180px;" disabled>
          <button type="button" class="btn small" id="btn-otp-verify" disabled>é€²è¡Œé©—è­‰</button>
          <span class="pill bad" id="pill-otp">å°šæœªé©—è­‰</span>
        </div>

        <div class="mini" id="otpHint" style="margin-top:8px; display:none;"></div>
      </div>

      <!-- é€å‡º -->
      <div class="section">
        <button type="submit" class="btn" id="btn-submit" disabled>
          <span class="icon">âœ…</span>
          <span>é€å‡ºè³‡æ–™</span>
        </button>
        <div class="status" id="status"></div>
      </div>
    </form>
  </div>

  <script>
    const LIFF_ID = "2008039127-p7We0QWm"; // æ›æˆä½ çš„ LIFF ID

    const nameInput = document.getElementById("name");
    const phoneInput = document.getElementById("phone");
    const addressInput = document.getElementById("address");
    const statusEl = document.getElementById("status");
    const form = document.getElementById("member-form");

    const pillLiff = document.getElementById("pill-liff");
    const pillClient = document.getElementById("pill-client");
    const pillLogin = document.getElementById("pill-login");
    const userBodyEl = document.getElementById("user-body");

    const captchaCanvas = document.getElementById("captchaCanvas");
    const btnCaptchaRefresh = document.getElementById("btn-captcha-refresh");
    const captchaInput = document.getElementById("captchaInput");
    const btnCaptchaVerify = document.getElementById("btn-captcha-verify");
    const pillCaptcha = document.getElementById("pill-captcha");

    const btnOtpSend = document.getElementById("btn-otp-send");
    const pillOtpSend = document.getElementById("pill-otp-send");
    const otpInput = document.getElementById("otpInput");
    const btnOtpVerify = document.getElementById("btn-otp-verify");
    const pillOtp = document.getElementById("pill-otp");
    const otpHint = document.getElementById("otpHint");

    const btnSubmit = document.getElementById("btn-submit");

    let liffReady = false;
    let liffProfile = null;

    // URL åƒæ•¸
    let oaid = "";
    let dbName = ""; // ç”± oa_lookup å–å›

    // captcha/otpï¼ˆå…ˆæ±‚æœ‰ï¼‰
    let captchaCode = "";
    let captchaVerified = false;

    let otpVerified = false;
    let bindToken = "";

    function setPill(el, ok, text) {
      el.classList.remove("ok", "bad");
      el.classList.add(ok ? "ok" : "bad");
      el.textContent = text;
    }

    function escapeHtml(s) {
      return (s ?? "").toString()
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function normalizePhone(phone) {
      return (phone || "").replace(/\D/g, "");
    }

    function canSubmit() {
      const nameOk = !!nameInput.value.trim();
      const phoneOk = normalizePhone(phoneInput.value.trim()).length >= 8;
      const liffOk = liffReady && window.liff && liff.isInClient();
      return liffOk && nameOk && phoneOk && captchaVerified && otpVerified && !!bindToken;
    }

    function refreshSubmitState() {
      btnSubmit.disabled = !canSubmit();
    }

    // -------------------------
    // è®€ URL oaid
    // -------------------------
    function getOaIdFromUrl() {
      const qs = new URLSearchParams(location.search);
      return qs.get("oaid") || "";
    }

    // -------------------------
    // å‘¼å« sqlgate: oa_lookup -> db_name
    // -------------------------
async function lookupDbNameByOaId(oaidValue) {
  if (!oaidValue) return "";

  // å…ˆç”¨ GET
  try {
    const url = `https://cwsoft.leaflune.org/sqlgate/oa_lookup?oaid=${encodeURIComponent(oaidValue)}`;
    const res = await fetch(url, { method: "GET", mode: "cors", cache: "no-store" });
    const data = await res.json().catch(() => ({}));

    if (res.ok && data?.ok) {
      // âœ… ä½ ç›®å‰çš„æ ¼å¼ï¼š{ ok:true, items:[{db_name:...}] }
      const first = Array.isArray(data.items) ? data.items[0] : null;
      if (first?.db_name) return first.db_name;

      // å…¼å®¹ï¼šæœªä¾†è‹¥æ”¹æˆç›´æ¥å›å‚³ db_name
      if (data.db_name) return data.db_name;
      if (data.dbName) return data.dbName;
    }
  } catch (e) {
    console.error("oa_lookup GET failed:", e);
  }

  // fallback: POST JSONï¼ˆå¦‚æœä½ ä¹‹å¾Œæœ‰åšï¼‰
  try {
    const res = await fetch("https://cwsoft.leaflune.org/sqlgate/oa_lookup", {
      method: "POST",
      mode: "cors",
      cache: "no-store",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ oaid: oaidValue }),
    });
    const data = await res.json().catch(() => ({}));

    if (res.ok && data?.ok) {
      const first = Array.isArray(data.items) ? data.items[0] : null;
      if (first?.db_name) return first.db_name;

      if (data.db_name) return data.db_name;
      if (data.dbName) return data.dbName;
    }
  } catch (e) {
    console.error("oa_lookup POST failed:", e);
  }

  return "";
}

    // -------------------------
    // ä½¿ç”¨è€…è³‡è¨Šæ¸²æŸ“
    // -------------------------
    function renderUser(profile) {
      const rows = [];

      rows.push(`<div>oaidï¼š<code>${escapeHtml(oaid || "ï¼ˆæœªæä¾›ï¼‰")}</code></div>`);
      rows.push(`<div>db_nameï¼š<code>${escapeHtml(dbName || "ï¼ˆæŸ¥è©¢ä¸­/å°šæœªå–å¾—ï¼‰")}</code></div>`);

      if (!profile) {
        rows.push(`<div>uidï¼š<code>ï¼ˆå°šæœªå–å¾—ï¼‰</code></div>`);
        userBodyEl.innerHTML = rows.join("");
        return;
      }

      rows.push(`<div>displayNameï¼š<b>${escapeHtml(profile.displayName)}</b></div>`);
      rows.push(`<div>uidï¼š<code>${escapeHtml(profile.userId)}</code></div>`);

      userBodyEl.innerHTML = rows.join("");
    }

    // -------------------------
    // CAPTCHA
    // -------------------------
    function randomDigits(n) {
      let out = "";
      for (let i = 0; i < n; i++) out += Math.floor(Math.random() * 10);
      return out;
    }

    function drawCaptcha(code) {
      const ctx = captchaCanvas.getContext("2d");
      const w = captchaCanvas.width;
      const h = captchaCanvas.height;

      ctx.clearRect(0, 0, w, h);
      ctx.fillStyle = "rgba(255,255,255,0.06)";
      ctx.fillRect(0, 0, w, h);

      for (let i = 0; i < 10; i++) {
        ctx.strokeStyle = `rgba(255,255,255,${0.08 + Math.random() * 0.12})`;
        ctx.beginPath();
        ctx.moveTo(Math.random() * w, Math.random() * h);
        ctx.lineTo(Math.random() * w, Math.random() * h);
        ctx.stroke();
      }

      ctx.font = "bold 34px system-ui, -apple-system, Segoe UI, Roboto";
      ctx.textBaseline = "middle";
      for (let i = 0; i < code.length; i++) {
        const ch = code[i];
        const x = 18 + i * 32;
        const y = h / 2 + (Math.random() * 6 - 3);
        const rot = (Math.random() * 0.35 - 0.175);
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(rot);
        ctx.fillStyle = "rgba(255,255,255,0.92)";
        ctx.fillText(ch, 0, 0);
        ctx.restore();
      }

      for (let i = 0; i < 60; i++) {
        ctx.fillStyle = `rgba(255,255,255,${0.05 + Math.random() * 0.12})`;
        ctx.fillRect(Math.random() * w, Math.random() * h, 1.5, 1.5);
      }
    }

    function resetCaptcha() {
      captchaCode = randomDigits(4);
      captchaVerified = false;
      captchaInput.value = "";
      drawCaptcha(captchaCode);
      setPill(pillCaptcha, false, "å°šæœªé©—è­‰");
      refreshSubmitState();
    }

    btnCaptchaRefresh.addEventListener("click", resetCaptcha);

    btnCaptchaVerify.addEventListener("click", () => {
      const v = (captchaInput.value || "").trim();
      if (v === captchaCode) {
        captchaVerified = true;
        setPill(pillCaptcha, true, "é©—è­‰é€šé âœ…");
      } else {
        captchaVerified = false;
        setPill(pillCaptcha, false, "éŒ¯èª¤ï¼Œè«‹é‡è©¦");
        resetCaptcha();
      }
      refreshSubmitState();
    });

    // -------------------------
    // OTPï¼šå‘¼å«å¾Œç«¯ /otpï¼ˆå…ˆæ±‚æœ‰ï¼šåªç™¼é€ï¼‰
    // -------------------------
    function resetOtp() {
      otpVerified = false;
      bindToken = "";

      otpInput.value = "";
      otpHint.style.display = "none";
      otpHint.textContent = "";

      setPill(pillOtpSend, false, "å°šæœªç™¼é€");
      setPill(pillOtp, false, "å°šæœªé©—è­‰");

      otpInput.disabled = true;
      btnOtpVerify.disabled = true;

      refreshSubmitState();
    }

    btnOtpSend.addEventListener("click", async () => {
      setPill(pillOtpSend, false, "ç™¼é€ä¸­â€¦");
      btnOtpSend.disabled = true;

      try {
        const res = await fetch("https://cwsoft.leaflune.org/otp", {
          method: "GET",
          mode: "cors",
          cache: "no-store",
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.ok === false) {
          throw new Error(data.error || `HTTP ${res.status}`);
        }

        setPill(pillOtpSend, true, "å·²è«‹æ±‚ç™¼é€ âœ…");
        otpHint.style.display = "block";
        otpHint.textContent = "å·²å‘å¾Œç«¯è«‹æ±‚ç™¼é€ OTP ç°¡è¨Šï¼Œè«‹æŸ¥çœ‹æ‰‹æ©Ÿæ”¶ä»¶ã€‚";

      } catch (err) {
        console.error("call /otp failed:", err);
        setPill(pillOtpSend, false, "ç™¼é€å¤±æ•—");
        otpHint.style.display = "block";
        otpHint.textContent = "å‘¼å« OTP æœå‹™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æª¢æŸ¥å¾Œç«¯/CORSã€‚";
      } finally {
        btnOtpSend.disabled = false;
        refreshSubmitState();
      }
    });

    // -------------------------
    // LIFF initï¼šå–å¾— uid + é¡¯ç¤º oaid + æŸ¥ db_name
    // -------------------------
    async function initLiff() {
      oaid = getOaIdFromUrl();     // å…ˆæ‹¿åˆ° oaid
      renderUser(null);            // å…ˆç•«ä¸€æ¬¡ï¼ˆé¡¯ç¤º oaid / db_name æŸ¥è©¢ä¸­ï¼‰

      // å…ˆåš db_name lookupï¼ˆä¸ä¾è³´ LIFFï¼‰
      if (oaid) {
        try {
          dbName = "æŸ¥è©¢ä¸­â€¦";
          renderUser(null);

          const found = await lookupDbNameByOaId(oaid);
          dbName = found || "ï¼ˆæŸ¥ç„¡å°æ‡‰ï¼‰";
        } catch (e) {
          console.error("oa_lookup failed:", e);
          dbName = "ï¼ˆæŸ¥è©¢å¤±æ•—ï¼‰";
        } finally {
          renderUser(liffProfile); // æœ‰/ç„¡ profile éƒ½é‡ç•«ä¸€æ¬¡
        }
      }

      if (!window.liff) {
        setPill(pillLiff, false, "LIFFï¼šæ‰¾ä¸åˆ° SDK");
        setPill(pillClient, false, "Clientï¼šæœªçŸ¥");
        setPill(pillLogin, false, "Loginï¼šæœªçŸ¥");
        return;
      }

      try {
        await liff.init({ liffId: LIFF_ID });
        liffReady = true;

        setPill(pillLiff, true, "LIFFï¼šå·²åˆå§‹åŒ– âœ…");
        setPill(pillClient, liff.isInClient(), `Clientï¼š${liff.isInClient() ? "æ˜¯" : "å¦"}`);

        if (!liff.isLoggedIn()) {
          setPill(pillLogin, false, "Loginï¼šæœªç™»å…¥");
          liff.login();
          return;
        }

        setPill(pillLogin, true, "Loginï¼šå·²ç™»å…¥ âœ…");

        liffProfile = await liff.getProfile();
        renderUser(liffProfile);

        // è‡ªå‹•æŠŠ displayName å¸¶å…¥å§“å
        if (!nameInput.value.trim() && liffProfile?.displayName) {
          nameInput.value = liffProfile.displayName;
        }

        statusEl.textContent = "";
        statusEl.className = "status";

      } catch (err) {
        console.error("LIFF init failed:", err);
        setPill(pillLiff, false, "LIFFï¼šåˆå§‹åŒ–å¤±æ•—");
        setPill(pillClient, false, "Clientï¼šæœªçŸ¥");
        setPill(pillLogin, false, "Loginï¼šæœªçŸ¥");
        statusEl.textContent = "LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ LIFF è¨­å®šã€‚";
        statusEl.className = "status error";
      } finally {
        refreshSubmitState();
      }
    }

    // -------------------------
    // Submitï¼ˆç›®å‰ä¸é€ Lineï¼‰
    // -------------------------
    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      statusEl.textContent = "ç›®å‰ç‰ˆæœ¬ï¼šä¸é€ Line è¨Šæ¯ã€‚";
      statusEl.className = "status success";
    });

    // input æ”¹å‹•åˆ·æ–°ç‹€æ…‹
    [nameInput, phoneInput, addressInput, captchaInput, otpInput].forEach(el => {
      el.addEventListener("input", refreshSubmitState);
    });

    // åˆå§‹åŒ–
    resetCaptcha();
    resetOtp();
    initLiff();
  </script>
</body>
</html>
