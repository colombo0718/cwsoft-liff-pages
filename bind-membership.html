<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>綁定會員</title>

  <!-- 你已移除 <style>：只用外部 CSS -->
  <link rel="stylesheet" href="./style.css" />

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>
  <div class="card">
    <div class="card-header">
      <div class="dot"></div>
      <div class="title-group">
        <h1>綁定會員</h1>
        <div class="subtitle">Line 官方帳號綁定</div>
      </div>
      <div class="badge">Demo</div>
    </div>

    <div class="hint">
      請填寫會員資料並完成驗證。<br />
      <span class="hintline">※ 系統會自動判斷是否已綁定；已綁定將鎖定輸入。</span>
    </div>

    <form id="member-form" autocomplete="off">
      <!-- 基本資料 -->
      <label>
        <div class="label-main">姓名 <span class="required">*</span></div>
        <input id="name" type="text" placeholder="例如：趙士豪" />
      </label>

      <label>
        <div class="label-main">手機號碼 <span class="required">*</span></div>
        <input id="phone" type="tel" placeholder="例如：0912-345-678" />
      </label>

      <label>
        <div class="label-main">通訊地址</div>
        <input id="address" type="text" placeholder="例如：台南市東區成功路 123 號" />
      </label>

      <!-- CAPTCHA -->
      <div class="section">
        <div class="mini">🛡️ 防機器人驗證（圖片碼）</div>
        <div class="mini">請輸入圖片中的 4 位數字（先求有：前端隨機產生）</div>

        <div class="captchaBox" style="margin-top:10px;">
          <canvas id="captchaCanvas" width="170" height="56"></canvas>
          <button type="button" class="btn small" id="btn-captcha-refresh">換一張</button>
        </div>

        <!-- 這行用 inline flex，避免依賴 .row -->
        <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <input id="captchaInput"
                 type="text"
                 inputmode="numeric"
                 placeholder="輸入四位數字"
                 maxlength="4"
                 style="flex:1; min-width:180px;" />
          <button type="button" class="btn small" id="btn-captcha-verify">驗證圖片碼</button>
          <span id="captchaVerifyStatus"
                style="font-size:12px; color:var(--muted); min-width:90px;">尚未驗證</span>
        </div>
      </div>

      <!-- OTP -->
      <div class="section">
        <div class="mini">📲 OTP 簡訊驗證</div>
        <div class="mini">
          點「取得 OTP」會呼叫後端 /otp 發送簡訊（目前先求有：verify 先用格式判斷）。
        </div>

        <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button type="button" class="btn small" id="btn-otp-send">取得 OTP</button>
          <span id="otpSendStatus" style="font-size:12px; color:var(--muted); min-width:120px;">尚未發送</span>
        </div>

        <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <input id="otpInput"
                 type="text"
                 inputmode="numeric"
                 placeholder="輸入 6 位 OTP"
                 maxlength="6"
                 style="flex:1; min-width:180px;" />
          <button type="button" class="btn small" id="btn-otp-verify">驗證 OTP</button>
          <span id="otpVerifyStatus" style="font-size:12px; color:var(--muted); min-width:90px;">尚未驗證</span>
        </div>
      </div>

      <!-- 送出 -->
      <div class="section">
        <button type="submit" class="btn" id="btn-submit" disabled>
          <span class="icon">✅</span>
          <span>送出資料</span>
        </button>

        <!-- 這裡只放「頁面級」訊息：LIFF/綁定鎖定/後端錯誤，不放各按鈕結果 -->
        <div class="status" id="status"></div>
      </div>

      <!-- Debug terminal：工程用 -->
      <div class="section">
        <div class="mini">Debug（工程用）</div>
        <pre id="debug"
             style="margin:8px 0 0; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.18); max-height:180px; overflow:auto;"
        >[debug] boot...</pre>
      </div>
    </form>
  </div>
  <script src="./core.js"></script>
  <script src="./captcha.js"></script>
  <script>
    // ====== Config ======
    const LIFF_ID = "2008039127-p7We0QWm"; // 你的 LIFF ID
    
    const API_OTP       = "https://cwsoft.leaflune.org/otp";
    const API_BIND      = "https://cwsoft.leaflune.org/bind";

    // 先求有：你之後會換成後端的一次性 token
    let bindToken = "DUMMY_TOKEN";


    // ====== Main init ======
    async function initAll() {
      dbg("init start");

      // 1) oaid
      oaid = getOaIdFromUrl();
      dbg(`oaid=${oaid || "(empty)"}`);

      // 2) lookup db
      await lookupDbNameByOaId(oaid);

      // 3) init LIFF
      try {
        await liff.init({ liffId: LIFF_ID });
        liffReady = true;
        dbg("LIFF：已初始化");
      } catch (e) {
        dbg(`LIFF init failed: ${e?.message || e}`);
        setStatus("LIFF 初始化失敗，請確認 LIFF ID/網路狀態", "error");
        refreshSubmitState();
        return;
      }

      // 4) login check
      if (!liff.isLoggedIn()) {
        dbg("Line：未登入 -> redirect login");
        setStatus("尚未登入 Line，準備跳轉登入…");
        liff.login();
        return;
      }
      dbg("Line：已登入");

      // 5) get profile
      try {
        liffProfile = await liff.getProfile();
        dbg(`profile ok: displayName=${liffProfile.displayName}, uid=${liffProfile.userId}`);
        autofillNameFromLineProfile();
        refreshSubmitState(); // 填入後順便更新送出按鈕狀態
      } catch (e) {
        dbg(`getProfile failed: ${e?.message || e}`);
        setStatus("取得使用者資訊失敗", "error");
        refreshSubmitState();
        return;
      }

      // 6) check bind
      try {
        const data = await checkIsBindMember(oaid, liffProfile.userId);
        if (!data.ok) throw new Error(data.error || "is_bind not ok");

        isBound = !!data.is_bound;
        memberNo = data.member_no ?? null;
        bindId = data.bind_id ?? null;

        if (isBound) {
          dbg(`Bind：已綁定 (member_no=${memberNo ?? "null"}, bind_id=${bindId ?? "null"})`);
          setStatus("此帳號已綁定會員，表單已鎖定。", "success");
          lockAllUI();
        } else {
          dbg("Bind：未綁定");
          setStatus("");
        }
      } catch (e) {
        dbg(`is_bind failed: ${e?.message || e}`);
        setStatus("查詢綁定狀態失敗（請稍後重試）", "error");
      }

      // 7) init captcha/otp
      resetCaptcha();
      resetOtp();

      // 8) wire input events
      [nameInput, phoneInput].forEach(el => el.addEventListener("input", refreshSubmitState));
      captchaInput.addEventListener("input", refreshSubmitState);
      otpInput.addEventListener("input", refreshSubmitState);

      refreshSubmitState();
      dbg("init done");
    }

    // ====== Events ======
    btnCaptchaRefresh.addEventListener("click", () => resetCaptcha());

    btnCaptchaVerify.addEventListener("click", () => {
      const v = (captchaInput.value || "").trim();
      if (v === captchaCode) {
        captchaVerified = true;
        dbg("CAPTCHA：驗證成功");
        setInline(captchaVerifyStatus, "驗證成功", "ok");
      } else {
        captchaVerified = false;
        dbg(`CAPTCHA：驗證失敗 (input=${v || "empty"})`);
        setInline(captchaVerifyStatus, "驗證失敗", "bad");
        // 可選：失敗就換一張，降低暴力嘗試
        resetCaptcha();
      }
      refreshSubmitState();
    });

    // 全域：記錄後端回傳的 otp（測試捷徑用）
    let lastOtp = null;

    btnOtpSend.addEventListener("click", async () => {
      setInline(otpSendStatus, "發送中…", "");
      dbg("OTP：send request...");
      console.log(oaid,normalizePhone(phoneInput.value))
      const lineOAID = (oaid || "").trim(); // 你原本就有 oaid
      const phone = normalizePhone(phoneInput.value);

      try {
        const url = new URL(`${API_OTP}/send`);
        url.searchParams.set("lineOAID", lineOAID);
        url.searchParams.set("phone", phone);

        const res = await fetch(url.toString(), { method: "GET", mode: "cors", cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        // 可選：你想看回傳內容就讀 json
        const data = await res.json();
        console.log("otp send resp:", data);
        lastOtp = data?.otp ?? null;
        
        setInline(otpSendStatus, "已發送（先求有）", "ok");
        dbg("OTP：send ok");
      } catch (e) {
        setInline(otpSendStatus, "發送失敗", "bad");
        dbg(`OTP：send failed: ${e?.message || e}`);
      }
    });

btnOtpVerify.addEventListener("click", async () => {
  const v = (otpInput.value || "").trim();
  const phone = normalizePhone(phoneInput.value);

  // 先做基本格式檢查
  if (!/^\d{6}$/.test(v)) {
    otpVerified = false;
    setInline(otpVerifyStatus, "驗證失敗：需 6 位數字", "bad");
    dbg("OTP：verify failed (need 6 digits)");
    refreshSubmitState();
    return;
  }
  if (!phone) {
    otpVerified = false;
    setInline(otpVerifyStatus, "驗證失敗：請先填手機號碼", "bad");
    dbg("OTP：verify failed (no phone)");
    refreshSubmitState();
    return;
  }

  try {
    setInline(otpVerifyStatus, "驗證中…", "");
    dbg("OTP：check request...");

    // GET + query string
    const url = new URL(`${API_OTP}/check`);
    url.searchParams.set("phone", phone);
    url.searchParams.set("otp", v);

    const res = await fetch(url.toString(), {
      method: "GET",
      mode: "cors",
      cache: "no-store",
    });

    const data = await res.json().catch(() => ({}));
    dbg("OTP：check resp:");
    dbg(JSON.stringify(data));

    if (!res.ok || !data?.ok) {
      otpVerified = false;

      // 依後端 error 類型顯示訊息（先求有）
      const err = data?.error || `HTTP ${res.status}`;
      if (err.includes("expired")) {
        setInline(otpVerifyStatus, "驗證失敗：驗證碼已過期，請重新取得", "bad");
      } else if (err.includes("mismatch")) {
        setInline(otpVerifyStatus, "驗證失敗：驗證碼不正確", "bad");
      } else if (err.includes("no otp record")) {
        setInline(otpVerifyStatus, "驗證失敗：請先取得驗證碼", "bad");
      } else {
        setInline(otpVerifyStatus, "驗證失敗", "bad");
      }

      dbg(`OTP：verify failed: ${err}`);
    } else {
      // ✅ 成功：拿到 check_token，當成 bindToken
      bindToken = data.check_token || "";
      otpVerified = !!bindToken;

      if (otpVerified) {
        setInline(otpVerifyStatus, "驗證成功", "ok");
        dbg("OTP：verify ok (backend check_token received)");
      } else {
        // 理論上不該發生
        setInline(otpVerifyStatus, "驗證失敗：未取得 token", "bad");
        dbg("OTP：verify failed (no check_token)");
      }
    }
  } catch (e) {
    otpVerified = false;
    setInline(otpVerifyStatus, "驗證失敗：網路或伺服器錯誤", "bad");
    dbg(`OTP：check failed: ${e?.message || e}`);
  }

  refreshSubmitState();
});



    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!canSubmit()) {
        dbg("submit blocked: canSubmit=false");
        setStatus("條件尚未完成，無法送出。", "error");
        return;
      }

      // 只送四個重要參數（先求有）
const payload4 = {
  lineOAID: oaid,
  lineUid: liffProfile?.userId || "",
  name: nameInput.value.trim(),
  phone: normalizePhone(phoneInput.value),
};

try {
  setStatus("送出中…", "");

  // GET：改用 query string
  const url = new URL(`${API_BIND}/submit`); // 例：https://cwsoft.leaflune.org/bind/submit
  url.searchParams.set("lineOAID", payload4.lineOAID);
  url.searchParams.set("lineUid", payload4.lineUid);
  url.searchParams.set("name", payload4.name);
  url.searchParams.set("phone", payload4.phone);

  const res = await fetch(url.toString(), {
    method: "GET",
    mode: "cors",
    cache: "no-store",
  });

  // 後端回 json 的話就讀出來方便 debug
  const data = await res.json().catch(() => null);

  if (!res.ok) {
    dbg("bind failed resp:");
    dbg(JSON.stringify(data));
    throw new Error(`HTTP ${res.status}`);
  }

  dbg("bind ok resp:");
  dbg(JSON.stringify(data));
  setStatus("綁定送出成功（先求有）", "ok");
} catch (err) {
  setStatus(`綁定送出失敗：${err?.message || err}`, "error");
}
    });

    // Boot
    initAll();
  </script>
</body>
</html>
