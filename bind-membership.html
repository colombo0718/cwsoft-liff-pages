<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>加入會員｜進階行銷方案 Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="style.css">

</head>
<body>
  <div class="card">
    <div class="card-header">
      <div class="dot"></div>
      <div class="title-group">
        <h1>加入會員</h1>
        <div class="subtitle">進階行銷方案 · Line 官方帳號綁定</div>
      </div>
      <div class="badge">Demo</div>
    </div>

    <div class="hint">
      請填寫您的基本資料，送出後會以一則訊息傳到 Line 對話視窗，<br>
      方便門市人員與系統完成會員綁定。
    </div>

    <form id="member-form">
      <label>
        <div class="label-main">
          手機號碼 <span class="required">*</span>
        </div>
        <input id="phone" type="tel" inputmode="numeric" placeholder="例如：0912-345-678" required />
      </label>

      <label>
        <div class="label-main">
          姓名 <span class="required">*</span>
        </div>
        <input id="name" type="text" placeholder="例如：王小明" required />
      </label>

      <label>
        <div class="label-main">
          通訊地址
        </div>
        <input id="address" type="text" placeholder="例如：台南市東區成功路 123 號" />
      </label>

      <label>
        <div class="label-main">
          備註
        </div>
        <textarea id="note" placeholder="例如：常用分店、特殊需求、生日等…"></textarea>
      </label>

      <button type="submit" class="btn">
        <span class="icon">✅</span>
        <span>送出，寫入 Line 訊息</span>
      </button>
    </form>

    <div class="status" id="status"></div>

    <div class="preview" id="preview">
      <div class="preview-title">📨 預覽：送到 Line 對話的內容</div>
      <div id="preview-body">（請先輸入上方資料…）</div>
    </div>

    <div class="env-warning" id="env-warning">
      ⚠️ 偵測不到 LIFF 環境，目前在一般瀏覽器模式。實際要測試送訊息，需要從 Line OA 的 LIFF 入口開啟。
    </div>
  </div>

  <script>
    const LIFF_ID = "2008039127-p7We0QWm"; // 記得換成你自己的 LIFF ID

    const phoneInput = document.getElementById("phone");
    const nameInput = document.getElementById("name");
    const addressInput = document.getElementById("address");
    const noteInput = document.getElementById("note");
    const statusEl = document.getElementById("status");
    const previewBodyEl = document.getElementById("preview-body");
    const envWarningEl = document.getElementById("env-warning");
    const form = document.getElementById("member-form");

    let liffReady = false;

    function buildMessageText() {
      const phone = phoneInput.value.trim();
      const name = nameInput.value.trim();
      const address = addressInput.value.trim();
      const note = noteInput.value.trim();

      let lines = [];
      lines.push("【加入會員申請】");
      if (name)   lines.push("姓名：" + name);
      if (phone)  lines.push("手機：" + phone);
      if (address) lines.push("地址：" + address);
      if (note)   lines.push("備註：" + note);

      return lines.join("\n");
    }

    function updatePreview() {
      const text = buildMessageText();
      previewBodyEl.textContent = text || "（請先輸入上方資料…）";
    }

    phoneInput.addEventListener("input", updatePreview);
    nameInput.addEventListener("input", updatePreview);
    addressInput.addEventListener("input", updatePreview);
    noteInput.addEventListener("input", updatePreview);

    async function initLiff() {
      if (!window.liff) {
        envWarningEl.style.display = "block";
        return;
      }

      try {
        await liff.init({ liffId: LIFF_ID });
        liffReady = true;

        if (!liff.isInClient()) {
          envWarningEl.style.display = "block";
        }
      } catch (err) {
        console.error("LIFF 初始化失敗：", err);
        statusEl.textContent = "LIFF 初始化失敗，請檢查 LIFF ID 或設定。";
        statusEl.className = "status error";
      }
    }

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      statusEl.textContent = "";
      statusEl.className = "status";

      const phone = phoneInput.value.trim();
      const name = nameInput.value.trim();

      if (!phone || !name) {
        statusEl.textContent = "請至少填寫「姓名」與「手機號碼」。";
        statusEl.className = "status error";
        return;
      }

      const text = buildMessageText();
      updatePreview();

      // 非 LIFF 環境，改成只顯示在畫面上，方便你在瀏覽器先看效果
      if (!liffReady || !liff.isInClient()) {
        console.log("Demo 模式：未在 LIFF 內，僅顯示訊息內容。");
        statusEl.textContent = "Demo 模式：目前不在 LIFF 內，只顯示預覽，不會真的送訊息。";
        statusEl.className = "status success";
        return;
      }

      try {
        await liff.sendMessages([
          {
            type: "text",
            text
          }
        ]);
        statusEl.textContent = "已將加入會員資訊送到 Line 對話視窗，請等待門市人員處理。";
        statusEl.className = "status success";

        // 可選：送出後關閉 LIFF
        // setTimeout(() => liff.closeWindow(), 800);
      } catch (err) {
        console.error("送訊息失敗：", err);
        statusEl.textContent = "送訊息失敗，請稍後再試或洽門市人員。";
        statusEl.className = "status error";
      }
    });

    // 初始化
    updatePreview();
    initLiff();
  </script>
</body>
</html>
