<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç¶å®šæœƒå“¡</title>

  <!-- å¤–éƒ¨ CSSï¼ˆä½ å·²æŠŠ <style> å…¨æ¬èµ°ï¼‰ -->
  <link rel="stylesheet" href="./style.css" />

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>
  <div class="card">
    <div class="card-header">
      <div class="dot"></div>
      <div class="title-group">
        <h1>ç¶å®šæœƒå“¡</h1>
        <div class="subtitle">Line å®˜æ–¹å¸³è™Ÿç¶å®š</div>
      </div>
      <div class="badge">Demo</div>
    </div>

    <div class="hint">
      è«‹å¡«å¯«æœƒå“¡è³‡æ–™ä¸¦å®Œæˆé©—è­‰ã€‚<br />
      <span class="hintline">â€» é€™é æœƒè‡ªå‹•åˆ¤æ–·æ˜¯å¦å·²ç¶å®šï¼Œå·²ç¶å®šå°‡é–å®šè¼¸å…¥ã€‚</span>
    </div>

    <form id="member-form" autocomplete="off">
      <!-- åŸºæœ¬è³‡æ–™ -->
      <label>
        <div class="label-main">å§“å <span class="required">*</span></div>
        <input id="name" type="text" placeholder="ä¾‹å¦‚ï¼šè¶™å£«è±ª" />
      </label>

      <label>
        <div class="label-main">æ‰‹æ©Ÿè™Ÿç¢¼ <span class="required">*</span></div>
        <input id="phone" type="tel" placeholder="ä¾‹å¦‚ï¼š0912-345-678" />
      </label>

      <label>
        <div class="label-main">é€šè¨Šåœ°å€</div>
        <input id="address" type="text" placeholder="ä¾‹å¦‚ï¼šå°å—å¸‚æ±å€æˆåŠŸè·¯ 123 è™Ÿ" />
      </label>

      <!-- CAPTCHA -->
      <div class="section">
        <div class="mini">ğŸ›¡ï¸ é˜²æ©Ÿå™¨äººé©—è­‰</div>
        <div class="mini">è«‹è¼¸å…¥åœ–ç‰‡ä¸­çš„ 4 ä½æ•¸å­—ï¼ˆå…ˆæ±‚æœ‰ç‰ˆï¼Œå‰ç«¯éš¨æ©Ÿç”¢ç”Ÿï¼‰</div>

        <div class="captchaBox" style="margin-top:10px;">
          <canvas id="captchaCanvas" width="170" height="56"></canvas>
          <button type="button" class="btn small" id="btn-captcha-refresh">æ›ä¸€å¼µ</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <input id="captchaInput" type="text" inputmode="numeric" placeholder="è¼¸å…¥å››ä½æ•¸å­—" maxlength="4" style="flex:1; min-width:180px;" />
          <button type="button" class="btn small" id="btn-captcha-verify">é©—è­‰</button>
        </div>
      </div>

      <!-- OTP -->
      <div class="section">
        <div class="mini">ğŸ“² OTP ç°¡è¨Šé©—è­‰</div>
        <div class="mini" id="otpHint">
          é»ã€Œå–å¾—é©—è­‰ç¢¼ã€æœƒå‘¼å«å¾Œç«¯ /otp é€ç°¡è¨Šï¼ˆç›®å‰å…ˆæ±‚æœ‰ï¼šä¸åš verifyï¼‰ã€‚
        </div>

        <div class="row" style="margin-top:10px;">
          <button type="button" class="btn small" id="btn-otp-send">å–å¾—é©—è­‰ç¢¼</button>
          <span class="mini" id="otpSendStatus">å°šæœªç™¼é€</span>
        </div>

        <div class="row" style="margin-top:10px;">
          <input id="otpInput" type="text" inputmode="numeric" placeholder="è¼¸å…¥ 6 ä½ OTP" maxlength="6" style="flex:1; min-width:180px;" />
          <button type="button" class="btn small" id="btn-otp-verify">é€²è¡Œé©—è­‰</button>
          <span class="mini" id="otpVerifyStatus">å°šæœªé©—è­‰</span>
        </div>
      </div>

      <!-- é€å‡º -->
      <div class="section">
        <button type="submit" class="btn" id="btn-submit" disabled>
          <span class="icon">âœ…</span>
          <span>é€å‡ºè³‡æ–™</span>
        </button>
        <div class="status" id="status"></div>
      </div>

      <!-- Debug terminalï¼ˆåªæœ‰ä¸€å€‹æ¡†ï¼Œä¸çµ¦ä¸€èˆ¬ user ç”¨ï¼‰ -->
      <div class="section">
        <div class="mini">Debugï¼ˆå·¥ç¨‹ç”¨ï¼‰</div>
        <pre id="debug"
             style="margin:8px 0 0; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.18); max-height:180px; overflow:auto;"
        >[debug] boot...</pre>
      </div>
    </form>
  </div>

  <script>
    // ====== Config ======
    const LIFF_ID = "2008039127-p7We0QWm"; // ä½ çš„ LIFF ID
    const API_OA_LOOKUP = "https://cwsoft.leaflune.org/sqlgate/oa_lookup";
    const API_IS_BIND  = "https://cwsoft.leaflune.org/sqlgate/is_bind_member";
    const API_OTP      = "https://cwsoft.leaflune.org/otp";

    // å…ˆæ±‚æœ‰ï¼šä½ ä¹‹å¾Œæœƒæ›æˆå¾Œç«¯çš„ä¸€æ¬¡æ€§ token
    let bindToken = "DUMMY_TOKEN";

    // ====== DOM (ç›¡é‡å°‘æŠ“) ======
    const $ = (id) => document.getElementById(id);
    const form = $("member-form");
    const nameInput = $("name");
    const phoneInput = $("phone");
    const addressInput = $("address");

    const captchaCanvas = $("captchaCanvas");
    const btnCaptchaRefresh = $("btn-captcha-refresh");
    const captchaInput = $("captchaInput");
    const btnCaptchaVerify = $("btn-captcha-verify");

    const btnOtpSend = $("btn-otp-send");
    const otpSendStatus = $("otpSendStatus");
    const otpInput = $("otpInput");
    const btnOtpVerify = $("btn-otp-verify");
    const otpVerifyStatus = $("otpVerifyStatus");

    const btnSubmit = $("btn-submit");
    const statusEl = $("status");

    // Debug terminalï¼šåªæŠ“é€™ä¸€å€‹
    const debugEl = $("debug");

    // ====== State ======
    let oaid = "";
    let dbName = "";
    let liffReady = false;
    let liffProfile = null;

    let captchaCode = "";
    let captchaVerified = false;

    let otpVerified = false;

    let isBound = false;
    let memberNo = null;
    let bindId = null;

    // ====== Utils ======
    function dbg(line) {
      const t = new Date().toISOString().slice(11, 19); // HH:MM:SS
      debugEl.textContent += `\n[${t}] ${line}`;
      debugEl.scrollTop = debugEl.scrollHeight;
    }

    function setStatus(text, type) {
      statusEl.className = "status" + (type ? " " + type : "");
      statusEl.textContent = text || "";
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function normalizePhone(raw) {
      const s = String(raw || "").trim().replaceAll(" ", "").replaceAll("-", "");
      return s;
    }

    function getOaIdFromUrl() {
      const u = new URL(location.href);
      // ä½ ç›®å‰ç”¨ ?oaid=...
      return (u.searchParams.get("oaid") || "").trim();
    }

    function lockAllUI() {
      [nameInput, phoneInput, addressInput, captchaInput, otpInput].forEach(el => el.disabled = true);
      [btnCaptchaRefresh, btnCaptchaVerify, btnOtpSend, btnOtpVerify, btnSubmit].forEach(el => el.disabled = true);
    }

    function canSubmit() {
      const nameOk = nameInput.value.trim().length > 0;
      const phoneOk = normalizePhone(phoneInput.value).length >= 10; // å…ˆæ±‚æœ‰
      const liffOk = liffReady && window.liff && liff.isLoggedIn() && liffProfile?.userId;
      const oaOk = !!oaid && !!dbName && !dbName.includes("æŸ¥ç„¡") && !dbName.includes("å¤±æ•—") && !dbName.includes("æœªæä¾›");
      return !!liffOk && nameOk && phoneOk && captchaVerified && otpVerified && !!bindToken && oaOk && !isBound;
    }

    function refreshSubmitState() {
      btnSubmit.disabled = !canSubmit();
    }

    // ====== OA lookup ======
    async function lookupDbNameByOaId(oaidValue) {
      if (!oaidValue) {
        dbName = "ï¼ˆæœªæä¾› oaidï¼‰";
        dbg(`oaid missing -> db_name=${dbName}`);
        return;
      }
      try {
        const url = `${API_OA_LOOKUP}?oaid=${encodeURIComponent(oaidValue)}`;
        const res = await fetch(url, { method: "GET", mode: "cors", cache: "no-store" });
        const data = await res.json().catch(() => ({}));
        console.log(data)
        if (!res.ok || !data?.ok) {
          dbName = "ï¼ˆæŸ¥è©¢å¤±æ•—ï¼‰";
          dbg(`oa_lookup failed: HTTP ${res.status} / ${data?.error || "unknown"}`);
          return;
        }

        dbName = data?.db_name || "ï¼ˆæŸ¥ç„¡å°æ‡‰ï¼‰";
        dbg(`oa_lookup ok -> oaid=${oaidValue}, db_name=${dbName}`);
      } catch (e) {
        dbName = "ï¼ˆæŸ¥è©¢å¤±æ•—ï¼‰";
        dbg(`oa_lookup exception: ${e?.message || e}`);
      }
    }

    // ====== is_bind_member ======
    async function checkIsBindMember(oaidValue, uidValue) {
      if (!oaidValue || !uidValue) return { ok:false, error:"missing params" };
      const url = `${API_IS_BIND}?oaid=${encodeURIComponent(oaidValue)}&uid=${encodeURIComponent(uidValue)}`;
      const res = await fetch(url, { method: "GET", mode: "cors", cache: "no-store" });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data?.ok) return { ok:false, error:(data?.error || `HTTP ${res.status}`) };
      return data;
    }

    // ====== CAPTCHA ======
    function randomDigits(n) {
      let out = "";
      for (let i = 0; i < n; i++) out += Math.floor(Math.random() * 10);
      return out;
    }

    function drawCaptcha(code) {
      const ctx = captchaCanvas.getContext("2d");
      const w = captchaCanvas.width, h = captchaCanvas.height;
      ctx.clearRect(0, 0, w, h);

      // bg
      ctx.fillStyle = "rgba(255,255,255,0.04)";
      ctx.fillRect(0, 0, w, h);

      // noise lines
      for (let i = 0; i < 7; i++) {
        ctx.strokeStyle = `rgba(255,255,255,${0.05 + Math.random() * 0.12})`;
        ctx.beginPath();
        ctx.moveTo(Math.random() * w, Math.random() * h);
        ctx.lineTo(Math.random() * w, Math.random() * h);
        ctx.stroke();
      }

      // text
      ctx.font = "bold 34px system-ui, -apple-system, Segoe UI";
      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.textBaseline = "middle";
      ctx.fillText(code, 18, h / 2 + 2);

      // dots
      for (let i = 0; i < 80; i++) {
        ctx.fillStyle = `rgba(255,255,255,${0.05 + Math.random() * 0.12})`;
        ctx.fillRect(Math.random() * w, Math.random() * h, 1.5, 1.5);
      }
    }

    function resetCaptcha() {
      captchaCode = randomDigits(4);
      captchaVerified = false;
      captchaInput.value = "";
      drawCaptcha(captchaCode);
      dbg("CAPTCHA reset");
      refreshSubmitState();
    }

    // ====== OTP (å…ˆæ±‚æœ‰) ======
    function resetOtp() {
      otpVerified = false;
      otpInput.value = "";
      otpSendStatus.textContent = "å°šæœªç™¼é€";
      otpVerifyStatus.textContent = "å°šæœªé©—è­‰";
      refreshSubmitState();
    }

    // ====== Main init ======
    async function initAll() {
      dbg("init start");

      // 1) oaid
      oaid = getOaIdFromUrl();
      dbg(`oaid=${oaid || "(empty)"}`);

      // 2) lookup db
      await lookupDbNameByOaId(oaid);

      // 3) init LIFF
      try {
        await liff.init({ liffId: LIFF_ID });
        liffReady = true;
        dbg("LIFFï¼šå·²åˆå§‹åŒ–");
      } catch (e) {
        dbg(`LIFF init failed: ${e?.message || e}`);
        setStatus("LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¢ºèª LIFF ID/ç¶²è·¯ç‹€æ…‹", "error");
        refreshSubmitState();
        return;
      }

      // 4) login check
      if (!liff.isLoggedIn()) {
        dbg("Lineï¼šæœªç™»å…¥ -> redirect login");
        setStatus("å°šæœªç™»å…¥ Lineï¼Œæº–å‚™è·³è½‰ç™»å…¥â€¦");
        liff.login();
        return;
      }
      dbg("Lineï¼šå·²ç™»å…¥");

      // 5) get profile
      try {
        liffProfile = await liff.getProfile();
        dbg(`profile ok: displayName=${liffProfile.displayName}, uid=${liffProfile.userId}`);
      } catch (e) {
        dbg(`getProfile failed: ${e?.message || e}`);
        setStatus("å–å¾—ä½¿ç”¨è€…è³‡è¨Šå¤±æ•—", "error");
        refreshSubmitState();
        return;
      }

      // 6) check bind
      try {
        const data = await checkIsBindMember(oaid, liffProfile.userId);
        if (!data.ok) throw new Error(data.error || "is_bind_member not ok");

        isBound = !!data.is_bound;
        memberNo = data.member_no ?? null;
        bindId = data.bind_id ?? null;

        if (isBound) {
          dbg(`Bindï¼šå·²ç¶å®š (member_no=${memberNo ?? "null"}, bind_id=${bindId ?? "null"})`);
          setStatus("æ­¤å¸³è™Ÿå·²ç¶å®šæœƒå“¡ï¼Œè¡¨å–®å·²é–å®šã€‚", "success");
          lockAllUI();
        } else {
          dbg("Bindï¼šæœªç¶å®š");
          setStatus("");
        }
      } catch (e) {
        dbg(`is_bind_member failed: ${e?.message || e}`);
        setStatus("æŸ¥è©¢ç¶å®šç‹€æ…‹å¤±æ•—ï¼ˆè«‹ç¨å¾Œé‡è©¦ï¼‰", "error");
      }

      // 7) init captcha/otp
      resetCaptcha();
      resetOtp();

      // 8) wire input events
      [nameInput, phoneInput].forEach(el => el.addEventListener("input", refreshSubmitState));
      captchaInput.addEventListener("input", refreshSubmitState);
      otpInput.addEventListener("input", refreshSubmitState);

      refreshSubmitState();
      dbg("init done");
    }

    // ====== Events ======
    btnCaptchaRefresh.addEventListener("click", () => {
      resetCaptcha();
    });

    btnCaptchaVerify.addEventListener("click", () => {
      const v = (captchaInput.value || "").trim();
      if (v === captchaCode) {
        captchaVerified = true;
        dbg("CAPTCHAï¼šé©—è­‰æˆåŠŸ");
        setStatus("CAPTCHA é©—è­‰æˆåŠŸ", "success");
      } else {
        captchaVerified = false;
        dbg(`CAPTCHAï¼šé©—è­‰å¤±æ•— (input=${v || "empty"})`);
        setStatus("CAPTCHA é©—è­‰å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡", "error");
      }
      refreshSubmitState();
    });

    btnOtpSend.addEventListener("click", async () => {
      // å…ˆæ±‚æœ‰ï¼šç›®å‰ /otp æ²’å¸¶ phoneï¼›ä½ ä¹‹å¾Œæœƒæ”¹æˆ /otp/send ä¸¦å¸¶ phone/oaid/uid
      otpSendStatus.textContent = "ç™¼é€ä¸­â€¦";
      dbg("OTPï¼šsend request...");
      try {
        const res = await fetch(API_OTP, { method: "GET", mode: "cors", cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        otpSendStatus.textContent = "å·²ç™¼é€ï¼ˆå…ˆæ±‚æœ‰ï¼‰";
        dbg("OTPï¼šsend ok");
      } catch (e) {
        otpSendStatus.textContent = "ç™¼é€å¤±æ•—";
        dbg(`OTPï¼šsend failed: ${e?.message || e}`);
      }
    });

    btnOtpVerify.addEventListener("click", () => {
      // å…ˆæ±‚æœ‰ï¼šåªåšé•·åº¦åˆ¤æ–·ï¼ˆä½ ä¹‹å¾Œæ¥å¾Œç«¯ verifyï¼‰
      const v = (otpInput.value || "").trim();
      if (/^\d{6}$/.test(v)) {
        otpVerified = true;
        otpVerifyStatus.textContent = "å·²é©—è­‰ï¼ˆå…ˆæ±‚æœ‰ï¼‰";
        dbg("OTPï¼šverify ok (frontend stub)");
      } else {
        otpVerified = false;
        otpVerifyStatus.textContent = "é©—è­‰å¤±æ•—";
        dbg("OTPï¼šverify failed (need 6 digits)");
      }
      refreshSubmitState();
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!canSubmit()) {
        dbg("submit blocked: canSubmit=false");
        setStatus("æ¢ä»¶å°šæœªå®Œæˆï¼Œç„¡æ³•é€å‡ºã€‚", "error");
        return;
      }

      const payload = {
        oaid,
        db_name: dbName,
        uid: liffProfile?.userId || "",
        displayName: liffProfile?.displayName || "",
        name: nameInput.value.trim(),
        phone: normalizePhone(phoneInput.value),
        address: addressInput.value.trim(),
        bind_token: bindToken,

        // ä½ ä¹‹å¾Œè‹¥è¦å¾Œç«¯é©—è­‰èº«åˆ†ï¼Œå»ºè­°å¸¶ï¼š
        id_token: (window.liff?.getIDToken?.() || ""),
        access_token: (window.liff?.getAccessToken?.() || "")
      };

      dbg("submit payload:");
      dbg(JSON.stringify(payload));

      // TODOï¼šæ¥ä½ çœŸæ­£çš„ bind API
      setStatus("é€å‡ºæµç¨‹å¾…æ¥å¾Œç«¯ç¶å®š APIï¼ˆç›®å‰åªè¼¸å‡º debug logï¼‰", "");
    });

    // Boot
    initAll();
  </script>
</body>
</html>
