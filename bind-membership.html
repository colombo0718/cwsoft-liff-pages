<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç¶å®šæœƒå“¡</title>

  <!-- ä½ å·²ç§»é™¤ <style>ï¼šåªç”¨å¤–éƒ¨ CSS -->
  <link rel="stylesheet" href="./style.css?v=dev2" />

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>  
<div class="card">
  <h1>ç¶å®šæœƒå“¡</h1>

  <form id="member-form" autocomplete="off">
    <!-- åŸºæœ¬è³‡æ–™ -->
    <div class="block">
      <div class="block-title">ğŸ‘¤ åŸºæœ¬è³‡æ–™</div>
      <div class="hint">è«‹å¡«å¯«æœƒå“¡è³‡æ–™<br /></div>

      <label>
        <div class="label-main required">å§“å*</div>
        <input id="name" type="text" placeholder="ä¾‹å¦‚ï¼šè¶™å£«è±ª" />
      </label>

      <label>
        <div class="label-main required">æ‰‹æ©Ÿ*</div>
        <input id="phone" type="tel" placeholder="ä¾‹å¦‚ï¼š0912-345-678" />
      </label>

      <label>
        <div class="label-main">åœ°å€</div>

        <div class="row row-top8">
          <select id="addrCity" class="grow minw-100">
            <option value="">é¸æ“‡ç¸£å¸‚</option>
          </select>

          <select id="addrDistrict" class="grow minw-100" disabled>
            <option value="">é¸æ“‡å€åŸŸ</option>
          </select>
        </div>

        <input id="address" type="hidden" value="" />
      </label>
    </div>

    <!-- å®‰å…¨é©—è­‰ -->
    <div class="block">
      <div class="block-title">ğŸ›¡ï¸ å®‰å…¨é©—è­‰</div>
      <div class="hint">è«‹å®Œæˆå®‰å…¨é©—è­‰<br /></div>

      <!-- CAPTCHA -->
      <div class="label-main">åœ–ç‰‡</div>
      <div class="captchaBox captchaBox-top10">
        <button type="button" class="btn small" id="btn-captcha-refresh">âŸ³</button>
        <canvas id="captchaCanvas" width="170" height="50"></canvas>
        <input
          id="captchaInput"
          class="grow minw-180"
          type="text"
          inputmode="numeric"
          placeholder="è¼¸å…¥å·¦å´åœ–ç‰‡æ•¸å­—"
          maxlength="4"
        />
      </div>

      <!-- OTP -->
      <div class="label-main">ç°¡è¨Š</div>
      <div class="row row-top10">
        <button type="button" class="btn small" id="btn-otp-send">å–å¾—ç°¡è¨Šé©—è­‰ç¢¼</button>
        <input
          id="otpInput"
          class="grow minw-180"
          type="text"
          inputmode="numeric"
          placeholder="è¼¸å…¥ 6 ä½ OTP"
          maxlength="6"
        />
      </div>
    </div>

    <!-- é€å‡º -->
    <div class="section">
      <button type="submit" class="btn" id="btn-submit" disabled>
        <span>é€å‡ºè³‡æ–™</span>
      </button>

      <div class="status" id="status"></div>
    </div>

    <!-- Debug -->
    <div class="section">
      <div class="mini">Debugï¼ˆå·¥ç¨‹ç”¨ï¼‰</div>
      <pre id="debug" class="debug-box">[debug] boot...</pre>
    </div>
  </form>
</div>
  <script src="./core.js?ts=<?=Date.now()?"></script>
  <script src="./captcha.js?ts=<?=Date.now()?"></script>
  <script>
    // ====== Config ======
    const LIFF_ID_DEFAULT = "2008039127-p7We0QWm"; // ä½ çš„ LIFF ID
    // const LIFF_ID_DEFAULT = "2008039127-VV7xY5jY"; // æ¸¬è©¦ç”¨ LIFF ID
    
    const API_OTP       = "https://cwsoft.leaflune.org/otp";
    const API_BIND      = "https://cwsoft.leaflune.org/bind";

    // å…ˆæ±‚æœ‰ï¼šä½ ä¹‹å¾Œæœƒæ›æˆå¾Œç«¯çš„ä¸€æ¬¡æ€§ token
    let checkToken = "DUMMY_TOKEN";


    function getParam(name){
      return new URLSearchParams(location.search).get(name) || "";
    }

    // ====== Main init ======
    async function initAll() {
      dbg("init start");

      // 1) oaid
      oaid = getOaIdFromUrl();
      dbg(`oaid=${oaid || "(empty)"}`);

      // 2) lookup db
      await lookupDbNameByOaId(oaid);

      // 3) init LIFF

      const LIFF_ID = getParam("liffId") || LIFF_ID_DEFAULT;
      try {
        console.log(LIFF_ID)
        await liff.init({ liffId: LIFF_ID });
        liffReady = true;
        dbg("LIFFï¼šå·²åˆå§‹åŒ–");
      } catch (e) {
        dbg(`LIFF init failed: ${e?.message || e}`);
        setStatus("LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¢ºèª LIFF ID/ç¶²è·¯ç‹€æ…‹", "error");
        refreshSubmitState();
        return;
      }

      // 4) login check
      if (!liff.isLoggedIn()) {
        dbg("Lineï¼šæœªç™»å…¥ -> redirect login");
        setStatus("å°šæœªç™»å…¥ Lineï¼Œæº–å‚™è·³è½‰ç™»å…¥â€¦");
        liff.login();
        return;
      }
      dbg("Lineï¼šå·²ç™»å…¥");

      // 5) get profile
      try {
        liffProfile = await liff.getProfile();
        dbg(`profile ok: displayName=${liffProfile.displayName}, uid=${liffProfile.userId}`);
        autofillNameFromLineProfile();
        refreshSubmitState(); // å¡«å…¥å¾Œé †ä¾¿æ›´æ–°é€å‡ºæŒ‰éˆ•ç‹€æ…‹
      } catch (e) {
        dbg(`getProfile failed: ${e?.message || e}`);
        setStatus("å–å¾—ä½¿ç”¨è€…è³‡è¨Šå¤±æ•—", "error");
        refreshSubmitState();
        return;
      }

      // 6) check bind
      try {
        const data = await checkIsBindMember(oaid, liffProfile.userId);
        if (!data.ok) throw new Error(data.error || "is_bind not ok");

        isBound = !!data.is_bound;
        memberNo = data.member_no ?? null;
        bindId = data.bind_id ?? null;

        if (isBound) {
          dbg(`Bindï¼šå·²ç¶å®š (member_no=${memberNo ?? "null"}, bind_id=${bindId ?? "null"})`);
          setStatus("æ­¤å¸³è™Ÿå·²ç¶å®šæœƒå“¡ï¼Œè¡¨å–®å·²é–å®šã€‚", "success");
          lockAllUI();
        } else {
          dbg("Bindï¼šæœªç¶å®š");
          setStatus("");
        }
      } catch (e) {
        dbg(`is_bind failed: ${e?.message || e}`);
        setStatus("æŸ¥è©¢ç¶å®šç‹€æ…‹å¤±æ•—ï¼ˆè«‹ç¨å¾Œé‡è©¦ï¼‰", "error");
      }

      // 7) init captcha/otp
      resetCaptcha();
      resetOtp();
      initAddressDropdown(); // åœ°å€ä¸‹æ‹‰é¸å–®åˆå§‹åŒ–

      // 8) wire input events
      [nameInput, phoneInput].forEach(el => el.addEventListener("input", refreshSubmitState));
      captchaInput.addEventListener("input", refreshSubmitState);


      refreshSubmitState();
      dbg("init done");
    }

    // ====== Events ======
    btnCaptchaRefresh.addEventListener("click", () => resetCaptcha());

    // btnCaptchaVerify.addEventListener("click", () => {
    //   const v = (captchaInput.value || "").trim();
    //   if (v === captchaCode) {
    //     captchaVerified = true;
    //     dbg("CAPTCHAï¼šé©—è­‰æˆåŠŸ");
    //     // setInline(captchaVerifyStatus, "é©—è­‰æˆåŠŸ", "ok");
    //   } else {
    //     captchaVerified = false;
    //     dbg(`CAPTCHAï¼šé©—è­‰å¤±æ•— (input=${v || "empty"})`);
    //     // setInline(captchaVerifyStatus, "é©—è­‰å¤±æ•—", "bad");
    //     // å¯é¸ï¼šå¤±æ•—å°±æ›ä¸€å¼µï¼Œé™ä½æš´åŠ›å˜—è©¦
    //     resetCaptcha();
    //   }
    //   refreshSubmitState();
    // });
function verifyCaptchaNow() {
  const v = (captchaInput.value || "").trim();
  if (v === captchaCode) {
    captchaVerified = true;
    dbg("CAPTCHAï¼šé©—è­‰æˆåŠŸ");
    // setInline(captchaVerifyStatus, "é©—è­‰æˆåŠŸ", "ok");
  } else {
    captchaVerified = false;
    dbg(`CAPTCHAï¼šé©—è­‰å¤±æ•— (input=${v || "empty"})`);
    // setInline(captchaVerifyStatus, "é©—è­‰å¤±æ•—", "bad");
    // å¯é¸ï¼šå¤±æ•—å°±æ›ä¸€å¼µï¼Œé™ä½æš´åŠ›å˜—è©¦
    resetCaptcha();
  }
  refreshSubmitState();
}

captchaInput.addEventListener("input", () => {
  // åªç•™æ•¸å­—ï¼ˆé¿å…ä½¿ç”¨è€…è¼¸å…¥ç©ºç™½æˆ–å…¶ä»–å­—å…ƒï¼‰
  const digits = (captchaInput.value || "").replace(/\D/g, "").slice(0, 4);

  // å¦‚æœæœ‰æ¸…æ‰éæ•¸å­—ï¼Œå°±å›å¯«ï¼ˆä¿æŒ UI ä¸€è‡´ï¼‰
  if (captchaInput.value !== digits) captchaInput.value = digits;

  // æœªæ»¿ 4 ç¢¼ï¼šè¦–ç‚ºå°šæœªé©—è­‰
  if (digits.length < 4) {
    captchaVerified = false;
    refreshSubmitState();
    return;
  }

  // å‰›å¥½ 4 ç¢¼ï¼šè‡ªå‹•é©—è­‰
  verifyCaptchaNow();
});

btnOtpSend.addEventListener("click", async () => {
  // setInline(otpSendStatus, "ç™¼é€ä¸­â€¦", "");
  dbg("OTPï¼šsend request...");

  const lineOAID = (oaid || "").trim();
  const phone = normalizePhone(phoneInput.value);
  const db_name = (dbName || "").trim();   // âœ… æ–°å¢

  try {
    const url = new URL(`${API_OTP}/send`);
    url.searchParams.set("lineOAID", lineOAID);
    url.searchParams.set("phone", phone);
    url.searchParams.set("db_name", db_name); // âœ… æ–°å¢
    console.log(db_name,phone)
    const res = await fetch(url.toString(), {
      method: "GET",
      mode: "cors",
      cache: "no-store",
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();
    console.log("otp send resp:", data);

    // setInline(otpSendStatus, "å·²ç™¼é€ï¼ˆå…ˆæ±‚æœ‰ï¼‰", "ok");
    dbg("OTPï¼šsend ok");
  } catch (e) {
    // setInline(otpSendStatus, "ç™¼é€å¤±æ•—", "bad");
    dbg(`OTPï¼šsend failed: ${e?.message || e}`);
  }
});


      otpInput.addEventListener("input", () => {

        const digits = (otpInput.value || "").replace(/\D/g, "").slice(0, 6);
        
        if (otpInput.value !== digits) otpInput.value = digits;
        // console.log(digits)
        console.log(canSubmit())
        refreshSubmitState();
      });


form.addEventListener("submit", async (e) => {
  e.preventDefault();

  if (!canSubmit()) {
    dbg("submit blocked: canSubmit=false");
    setStatus("æ¢ä»¶å°šæœªå®Œæˆï¼Œç„¡æ³•é€å‡ºã€‚", "error");
    return;
  }

  const phone = normalizePhone(phoneInput.value);
  const otp = (otpInput.value || "").trim();

  try {
    setStatus("é©—è­‰ OTP ä¸­â€¦", "");

    // âœ… Step 1ï¼šé€å‡ºæ™‚æ‰åš OTP check
    const urlCheck = new URL(`${API_OTP}/check`);
    urlCheck.searchParams.set("phone", phone);
    urlCheck.searchParams.set("otp", otp);

    const resCheck = await fetch(urlCheck.toString(), {
      method: "GET",
      mode: "cors",
      cache: "no-store",
    });

    const dataCheck = await resCheck.json().catch(() => ({}));
    dbg("OTPï¼šcheck resp:");
    dbg(JSON.stringify(dataCheck));

    if (!resCheck.ok || !dataCheck?.ok) {
      const err = dataCheck?.error || `HTTP ${resCheck.status}`;
      dbg(`OTPï¼šcheck failed: ${err}`);

      // ä½ åŸæœ¬çš„éŒ¯èª¤æ–‡æ¡ˆæˆ‘æ²¿ç”¨ï¼ˆå…ˆæ±‚æœ‰ï¼‰
      if (String(err).includes("expired")) {
        setStatus("é©—è­‰å¤±æ•—ï¼šé©—è­‰ç¢¼å·²éæœŸï¼Œè«‹é‡æ–°å–å¾—", "error");
      } else if (String(err).includes("mismatch")) {
        setStatus("é©—è­‰å¤±æ•—ï¼šé©—è­‰ç¢¼ä¸æ­£ç¢º", "error");
      } else if (String(err).includes("no otp record")) {
        setStatus("é©—è­‰å¤±æ•—ï¼šè«‹å…ˆå–å¾—é©—è­‰ç¢¼", "error");
      } else {
        setStatus("é©—è­‰å¤±æ•—", "error");
      }
      return;
    }

    // âœ… æˆåŠŸï¼šæ‹¿ check_token
    checkToken = dataCheck.check_token || "";
    if (!checkToken) {
      dbg("OTPï¼šcheck ok but missing check_token");
      setStatus("é©—è­‰å¤±æ•—ï¼šæœªå–å¾— token", "error");
      return;
    }

    // âœ… Step 2ï¼šOTP OK å¾Œæ‰é€ bind
    setStatus("é€å‡ºä¸­â€¦", "");

    const urlBind = new URL(`${API_BIND}/submit`);
    urlBind.searchParams.set("lineOAID", oaid);
    urlBind.searchParams.set("lineUid", liffProfile?.userId || "");
    urlBind.searchParams.set("name", nameInput.value.trim());
    urlBind.searchParams.set("phone", phone);
    urlBind.searchParams.set("check_token", checkToken);

    const res = await fetch(urlBind.toString(), {
      method: "GET",
      mode: "cors",
      cache: "no-store",
    });

    const data = await res.json().catch(() => null);

    if (!res.ok) {
      dbg("bind failed resp:");
      dbg(JSON.stringify(data));
      throw new Error(`HTTP ${res.status}`);
    }

    dbg("bind ok resp:");
    dbg(JSON.stringify(data));
    setStatus("ç¶å®šé€å‡ºæˆåŠŸï¼ˆå…ˆæ±‚æœ‰ï¼‰", "success");
  } catch (err) {
    setStatus(`ç¶å®šé€å‡ºå¤±æ•—ï¼š${err?.message || err}`, "error");
  }
});

    // Boot
    initAll();
  </script>
</body>
</html>
