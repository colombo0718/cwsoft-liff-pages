<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç¶å®šæœƒå“¡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="card">
    <div class="card-header">
      <div class="dot"></div>
      <div class="title-group">
        <h1>ç¶å®šæœƒå“¡</h1>
        <div class="subtitle">Line å®˜æ–¹å¸³è™Ÿç¶å®š</div>
      </div>
      <div class="badge">Demo</div>
    </div>

    <!-- ä½¿ç”¨è€…è³‡è¨Š -->
    <div class="preview" style="margin-top:12px;">
      <div class="preview-title">ğŸ‘¤ ä½¿ç”¨è€…è³‡è¨Š</div>

      <div class="row" style="margin:8px 0 10px;">
        <span class="pill neu" id="pill-liff">LIFFï¼šåˆå§‹åŒ–ä¸­â€¦</span>
        <span class="pill neu" id="pill-client">Clientï¼šåˆ¤æ–·ä¸­â€¦</span>
        <span class="pill neu" id="pill-login">Loginï¼šåˆ¤æ–·ä¸­â€¦</span>
        <span class="pill neu" id="pill-bind">Bindï¼šæŸ¥è©¢ä¸­â€¦</span>
      </div>

      <div id="user-body" class="mini">ï¼ˆå°šæœªå–å¾—ä½¿ç”¨è€…è³‡æ–™ï¼‰</div>
      <div id="bind-extra" class="mini hintline" style="display:none;"></div>
    </div>

    <!-- è¡¨å–® -->
    <form id="member-form" class="section">
      <label>
        <div class="label-main">å§“å <span class="required">*</span></div>
        <input id="name" type="text" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" required />
      </label>

      <label>
        <div class="label-main">æ‰‹æ©Ÿè™Ÿç¢¼ <span class="required">*</span></div>
        <input id="phone" type="tel" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š0912-345-678" required />
      </label>

      <label>
        <div class="label-main">é€šè¨Šåœ°å€</div>
        <input id="address" type="text" placeholder="ä¾‹å¦‚ï¼šå°å—å¸‚æ±å€æˆåŠŸè·¯ 123 è™Ÿ" />
      </label>

      <!-- é˜²æ©Ÿå™¨äººé©—è­‰ -->
      <div class="section">
        <div class="label-main">ğŸ›¡ï¸ é˜²æ©Ÿå™¨äººé©—è­‰</div>
        <div class="mini" style="margin:6px 0 10px;">è«‹è¼¸å…¥åœ–ç‰‡ä¸­çš„ 4 ä½æ•¸å­—ï¼ˆå…ˆæ±‚æœ‰ç‰ˆï¼šå‰ç«¯éš¨æ©Ÿç”¢ç”Ÿï¼‰</div>

        <div class="captchaBox">
          <canvas id="captchaCanvas" width="160" height="56" aria-label="captcha"></canvas>
          <button type="button" class="btn small" id="btn-captcha-refresh">æ›ä¸€å¼µ</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <input id="captchaInput" type="text" inputmode="numeric" maxlength="4" placeholder="è¼¸å…¥å››ä½æ•¸å­—" style="flex:1; min-width:160px;">
          <button type="button" class="btn small" id="btn-captcha-verify">é©—è­‰</button>
          <span class="pill bad" id="pill-captcha">å°šæœªé©—è­‰</span>
        </div>
      </div>

      <!-- OTP -->
      <div class="section">
        <div class="label-main">ğŸ“± OTP ç°¡è¨Šé©—è­‰</div>
        <div class="mini" style="margin:6px 0 10px;">é»ã€Œå–å¾—é©—è­‰ç¢¼ã€æœƒå‘¼å«å¾Œç«¯ /otp ç™¼é€ç°¡è¨Šï¼ˆç›®å‰å…ˆæ±‚æœ‰ï¼šä¸åš verifyï¼‰</div>

        <div class="row" style="margin-bottom:10px;">
          <button type="button" class="btn small" id="btn-otp-send">å–å¾—é©—è­‰ç¢¼</button>
          <span class="pill bad" id="pill-otp-send">å°šæœªç™¼é€</span>
        </div>

        <div class="row">
          <input id="otpInput" type="text" inputmode="numeric" maxlength="6" placeholder="è¼¸å…¥ 6 ä½ OTP" style="flex:1; min-width:180px;" disabled>
          <button type="button" class="btn small" id="btn-otp-verify" disabled>é€²è¡Œé©—è­‰</button>
          <span class="pill bad" id="pill-otp">å°šæœªé©—è­‰</span>
        </div>

        <div class="mini" id="otpHint" style="margin-top:8px; display:none;"></div>
      </div>

      <!-- é€å‡º -->
      <div class="section">
        <button type="submit" class="btn" id="btn-submit" disabled>
          <span class="icon">âœ…</span>
          <span>é€å‡ºè³‡æ–™</span>
        </button>
        <div class="status" id="status"></div>
      </div>
    </form>
  </div>

  <script>
    const LIFF_ID = "2008039127-p7We0QWm"; // æ›æˆä½ çš„ LIFF ID

    // ---- endpoints ----
    const API_OA_LOOKUP = "https://cwsoft.leaflune.org/sqlgate/oa_lookup";
    const API_IS_BIND   = "https://cwsoft.leaflune.org/sqlgate/is_bind_member";
    const API_OTP       = "https://cwsoft.leaflune.org/otp";

    // ---- DOM ----
    const form = document.getElementById("member-form");
    const statusEl = document.getElementById("status");

    const pillLiff = document.getElementById("pill-liff");
    const pillClient = document.getElementById("pill-client");
    const pillLogin = document.getElementById("pill-login");
    const pillBind = document.getElementById("pill-bind");

    const userBodyEl = document.getElementById("user-body");
    const bindExtraEl = document.getElementById("bind-extra");

    const nameInput = document.getElementById("name");
    const phoneInput = document.getElementById("phone");
    const addressInput = document.getElementById("address");

    const captchaCanvas = document.getElementById("captchaCanvas");
    const btnCaptchaRefresh = document.getElementById("btn-captcha-refresh");
    const captchaInput = document.getElementById("captchaInput");
    const btnCaptchaVerify = document.getElementById("btn-captcha-verify");
    const pillCaptcha = document.getElementById("pill-captcha");

    const btnOtpSend = document.getElementById("btn-otp-send");
    const pillOtpSend = document.getElementById("pill-otp-send");
    const otpInput = document.getElementById("otpInput");
    const btnOtpVerify = document.getElementById("btn-otp-verify");
    const pillOtp = document.getElementById("pill-otp");
    const otpHint = document.getElementById("otpHint");

    const btnSubmit = document.getElementById("btn-submit");

    // ---- state ----
    let liffReady = false;
    let liffProfile = null; // { userId, displayName, ... }

    let oaid = "";
    let dbName = "";

    let isBound = false;
    let memberNo = null;
    let bindId = null;

    let captchaCode = "";
    let captchaVerified = false;

    let otpVerified = false; // å…ˆæ±‚æœ‰ï¼šç›®å‰ç”±ä½ æ±ºå®šä½•æ™‚æ”¹æˆçœŸçš„ verify
    let bindToken = "DUMMY_TOKEN"; // å…ˆæ±‚æœ‰ï¼ˆä½ å¾Œç«¯çœŸæ­£åšä¸€æ¬¡æ€§ token å†æ›æ‰ï¼‰

    // ---- utils ----
    function setPill(el, type, text) {
      el.classList.remove("ok", "bad", "neu");
      el.classList.add(type);
      el.textContent = text;
    }

    function escapeHtml(s) {
      return (s ?? "").toString()
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function normalizePhone(phone) {
      return (phone || "").replace(/\D/g, "");
    }

    function getOaIdFromUrl() {
      const qs = new URLSearchParams(location.search);
      return (qs.get("oaid") || "").trim();
    }

    function lockAllUI(reasonText) {
      // disable everything
      [nameInput, phoneInput, addressInput, captchaInput, otpInput].forEach(x => x.disabled = true);
      [btnCaptchaRefresh, btnCaptchaVerify, btnOtpSend, btnOtpVerify, btnSubmit].forEach(x => x.disabled = true);

      if (reasonText) {
        statusEl.textContent = reasonText;
        statusEl.className = "status success";
      }
    }

    function canSubmit() {
      if (isBound) return false;
      const nameOk = !!nameInput.value.trim();
      const phoneOk = normalizePhone(phoneInput.value.trim()).length >= 8;
      const liffOk = liffReady && window.liff && liff.isInClient() && liffProfile?.userId;
      return liffOk && nameOk && phoneOk && captchaVerified && otpVerified && !!bindToken && !!oaid && !!dbName;
    }

    function refreshSubmitState() {
      btnSubmit.disabled = !canSubmit();
    }

    function renderUser() {
      const rows = [];
      rows.push(`<div>oaidï¼š<code>${escapeHtml(oaid || "ï¼ˆæœªæä¾›ï¼‰")}</code></div>`);
      rows.push(`<div>db_nameï¼š<code>${escapeHtml(dbName || "ï¼ˆæŸ¥è©¢ä¸­/å°šæœªå–å¾—ï¼‰")}</code></div>`);

      if (!liffProfile) {
        rows.push(`<div>displayNameï¼š<b>ï¼ˆå°šæœªå–å¾—ï¼‰</b></div>`);
        rows.push(`<div>uidï¼š<code>ï¼ˆå°šæœªå–å¾—ï¼‰</code></div>`);
        userBodyEl.innerHTML = rows.join("");
        return;
      }

      rows.push(`<div>displayNameï¼š<b>${escapeHtml(liffProfile.displayName || "")}</b></div>`);
      rows.push(`<div>uidï¼š<code>${escapeHtml(liffProfile.userId || "")}</code></div>`);
      userBodyEl.innerHTML = rows.join("");
    }

    // ---- API calls ----
    async function lookupDbNameByOaId(oaidValue) {
      if (!oaidValue) return "";
      const url = `${API_OA_LOOKUP}?oaid=${encodeURIComponent(oaidValue)}`;
      const res = await fetch(url, { method: "GET", mode: "cors", cache: "no-store" });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data?.ok) return "";

      const first = Array.isArray(data.items) ? data.items[0] : null;
      return (first?.db_name) ? first.db_name : (data.db_name || data.dbName || "");
    }

    async function checkIsBindMember(oaidValue, uidValue) {
      if (!oaidValue || !uidValue) return { ok:false, error:"missing params" };

      const url = `${API_IS_BIND}?oaid=${encodeURIComponent(oaidValue)}&uid=${encodeURIComponent(uidValue)}`;
      const res = await fetch(url, { method: "GET", mode: "cors", cache: "no-store" });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data?.ok) return { ok:false, error:(data?.error || `HTTP ${res.status}`) };
      return data;
    }

    // ---- CAPTCHA ----
    function randomDigits(n) {
      let out = "";
      for (let i = 0; i < n; i++) out += Math.floor(Math.random() * 10);
      return out;
    }

    function drawCaptcha(code) {
      const ctx = captchaCanvas.getContext("2d");
      const w = captchaCanvas.width;
      const h = captchaCanvas.height;

      ctx.clearRect(0, 0, w, h);
      ctx.fillStyle = "rgba(255,255,255,0.06)";
      ctx.fillRect(0, 0, w, h);

      for (let i = 0; i < 10; i++) {
        ctx.strokeStyle = `rgba(255,255,255,${0.08 + Math.random() * 0.12})`;
        ctx.beginPath();
        ctx.moveTo(Math.random() * w, Math.random() * h);
        ctx.lineTo(Math.random() * w, Math.random() * h);
        ctx.stroke();
      }

      ctx.font = "bold 34px system-ui, -apple-system, Segoe UI, Roboto";
      ctx.textBaseline = "middle";
      for (let i = 0; i < code.length; i++) {
        const ch = code[i];
        const x = 18 + i * 32;
        const y = h / 2 + (Math.random() * 6 - 3);
        const rot = (Math.random() * 0.35 - 0.175);
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(rot);
        ctx.fillStyle = "rgba(255,255,255,0.92)";
        ctx.fillText(ch, 0, 0);
        ctx.restore();
      }

      for (let i = 0; i < 60; i++) {
        ctx.fillStyle = `rgba(255,255,255,${0.05 + Math.random() * 0.12})`;
        ctx.fillRect(Math.random() * w, Math.random() * h, 1.5, 1.5);
      }
    }

    function resetCaptcha() {
      captchaCode = randomDigits(4);
      captchaVerified = false;
      captchaInput.value = "";
      drawCaptcha(captchaCode);
      setPill(pillCaptcha, "bad", "å°šæœªé©—è­‰");
      refreshSubmitState();
    }

    btnCaptchaRefresh.addEventListener("click", () => {
      if (isBound) return;
      resetCaptcha();
    });

    btnCaptchaVerify.addEventListener("click", () => {
      if (isBound) return;
      const v = (captchaInput.value || "").trim();
      if (v === captchaCode) {
        captchaVerified = true;
        setPill(pillCaptcha, "ok", "é©—è­‰é€šé âœ…");
      } else {
        captchaVerified = false;
        setPill(pillCaptcha, "bad", "éŒ¯èª¤ï¼Œè«‹é‡è©¦");
        resetCaptcha();
      }
      refreshSubmitState();
    });

    // ---- OTP (å…ˆæ±‚æœ‰ï¼šåª send) ----
    function resetOtp() {
      otpVerified = false;
      otpInput.value = "";
      otpHint.style.display = "none";
      otpHint.textContent = "";

      setPill(pillOtpSend, "bad", "å°šæœªç™¼é€");
      setPill(pillOtp, "bad", "å°šæœªé©—è­‰");

      otpInput.disabled = true;
      btnOtpVerify.disabled = true;

      refreshSubmitState();
    }

    btnOtpSend.addEventListener("click", async () => {
      if (isBound) return;

      setPill(pillOtpSend, "neu", "ç™¼é€ä¸­â€¦");
      btnOtpSend.disabled = true;

      try {
        const res = await fetch(API_OTP, { method: "GET", mode: "cors", cache: "no-store" });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.ok === false) throw new Error(data.error || `HTTP ${res.status}`);

        setPill(pillOtpSend, "ok", "å·²è«‹æ±‚ç™¼é€ âœ…");
        otpHint.style.display = "block";
        otpHint.textContent = "å·²å‘å¾Œç«¯è«‹æ±‚ç™¼é€ OTP ç°¡è¨Šï¼Œè«‹æŸ¥çœ‹æ‰‹æ©Ÿæ”¶ä»¶ã€‚";

        // å…ˆæ±‚æœ‰ï¼šè§£é–è¼¸å…¥æ¡†/é©—è­‰æŒ‰éˆ•ï¼Œä½†ä½ ç›®å‰æ²’åš verify
        otpInput.disabled = false;
        btnOtpVerify.disabled = false;
      } catch (e) {
        console.error("call /otp failed:", e);
        setPill(pillOtpSend, "bad", "ç™¼é€å¤±æ•—");
        otpHint.style.display = "block";
        otpHint.textContent = "å‘¼å« OTP æœå‹™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
      } finally {
        btnOtpSend.disabled = false;
        refreshSubmitState();
      }
    });

    btnOtpVerify.addEventListener("click", () => {
      if (isBound) return;

      // å…ˆæ±‚æœ‰ï¼šæš«æ™‚åªè¦æœ‰å¡« 6 ä½å°±ç•¶ä½œéï¼ˆä½ ä¹‹å¾Œæ¥å¾Œç«¯ verify å†æ›ï¼‰
      const v = (otpInput.value || "").trim();
      if (/^\d{6}$/.test(v)) {
        otpVerified = true;
        setPill(pillOtp, "ok", "é©—è­‰é€šé âœ…");
      } else {
        otpVerified = false;
        setPill(pillOtp, "bad", "æ ¼å¼éŒ¯èª¤");
      }
      refreshSubmitState();
    });

    // ---- LIFF init + db lookup + is_bind_member ----
    async function initAll() {
      // 0) URL oaid
      oaid = getOaIdFromUrl();
      dbName = "";
      renderUser();

      // 1) db lookupï¼ˆä¸ä¾è³´ LIFFï¼‰
      setPill(pillBind, "neu", "Bindï¼šç­‰å¾… uidâ€¦");
      if (oaid) {
        try {
          dbName = "æŸ¥è©¢ä¸­â€¦";
          renderUser();
          const found = await lookupDbNameByOaId(oaid);
          dbName = found || "ï¼ˆæŸ¥ç„¡å°æ‡‰ï¼‰";
        } catch (e) {
          console.error("oa_lookup failed:", e);
          dbName = "ï¼ˆæŸ¥è©¢å¤±æ•—ï¼‰";
        } finally {
          renderUser();
        }
      } else {
        dbName = "ï¼ˆæœªæä¾› oaidï¼‰";
        renderUser();
      }

      // 2) LIFF
      if (!window.liff) {
        setPill(pillLiff, "bad", "LIFFï¼šæ‰¾ä¸åˆ° SDK");
        setPill(pillClient, "bad", "Clientï¼šæœªçŸ¥");
        setPill(pillLogin, "bad", "Loginï¼šæœªçŸ¥");
        setPill(pillBind, "bad", "Bindï¼šç„¡æ³•æŸ¥è©¢");
        return;
      }

      try {
        await liff.init({ liffId: LIFF_ID });
        liffReady = true;
        setPill(pillLiff, "ok", "LIFFï¼šå·²åˆå§‹åŒ– âœ…");

        const inClient = liff.isInClient();
        setPill(pillClient, inClient ? "ok" : "bad", `Clientï¼š${inClient ? "æ˜¯" : "å¦"}`);

        if (!liff.isLoggedIn()) {
          setPill(pillLogin, "bad", "Loginï¼šæœªç™»å…¥");
          liff.login();
          return;
        }
        setPill(pillLogin, "ok", "Loginï¼šå·²ç™»å…¥ âœ…");

        liffProfile = await liff.getProfile();
        renderUser();

        // è‡ªå‹•å¸¶å…¥å§“å
        if (!nameInput.value.trim() && liffProfile?.displayName) {
          nameInput.value = liffProfile.displayName;
        }

        // 3) is_bind_member
        setPill(pillBind, "neu", "Bindï¼šæŸ¥è©¢ä¸­â€¦");
        bindExtraEl.style.display = "none";
        bindExtraEl.textContent = "";

        const bindRes = await checkIsBindMember(oaid, liffProfile.userId);
        if (!bindRes.ok) {
          setPill(pillBind, "bad", "Bindï¼šæŸ¥è©¢å¤±æ•—");
          bindExtraEl.style.display = "block";
          bindExtraEl.textContent = "ç„¡æ³•æŸ¥è©¢ç¶å®šç‹€æ…‹ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
          refreshSubmitState();
          return;
        }

        isBound = !!bindRes.is_bound;
        memberNo = bindRes.member_no ?? null;
        bindId = bindRes.bind_id ?? null;

        if (isBound) {
          setPill(pillBind, "ok", "Bindï¼šå·²ç¶å®š âœ…");
          bindExtraEl.style.display = "block";
          bindExtraEl.innerHTML = [
            `<div>ç‹€æ…‹ï¼š<b>å·²ç¶å®šæœƒå“¡</b></div>`,
            `<div>member_noï¼š<code>${escapeHtml(memberNo ?? "ï¼ˆç©ºï¼‰")}</code></div>`,
            `<div>bind_idï¼š<code>${escapeHtml(bindId ?? "ï¼ˆç©ºï¼‰")}</code></div>`
          ].join("");
          lockAllUI("æ‚¨å·²å®Œæˆæœƒå“¡ç¶å®šï¼Œç„¡éœ€å†æ¬¡æ“ä½œã€‚");
          return;
        } else {
          setPill(pillBind, "bad", "Bindï¼šæœªç¶å®š");
          // æœªç¶å®š â†’ æ­£å¸¸ä½¿ç”¨
          resetCaptcha();
          resetOtp();
          statusEl.textContent = "";
          statusEl.className = "status";
        }
      } catch (e) {
        console.error("init failed:", e);
        setPill(pillLiff, "bad", "LIFFï¼šåˆå§‹åŒ–å¤±æ•—");
        setPill(pillClient, "bad", "Clientï¼šæœªçŸ¥");
        setPill(pillLogin, "bad", "Loginï¼šæœªçŸ¥");
        setPill(pillBind, "bad", "Bindï¼šæœªçŸ¥");
        statusEl.textContent = "LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ LIFF è¨­å®šã€‚";
        statusEl.className = "status error";
      } finally {
        refreshSubmitState();
      }
    }

    // ---- submit ----
    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      if (isBound) return;

      // ä½ ç›®å‰èªªï¼šå…ˆä¸é€ Lineï¼Œä¸åšçœŸæ­£å¾Œç«¯ bind
      statusEl.textContent = "ç›®å‰ç‰ˆæœ¬ï¼šå‰ç«¯å·²å®Œæˆç¶å®šç‹€æ…‹åˆ¤æ–·ï¼›é€å‡ºæµç¨‹å¾…æ¥å¾Œç«¯ç¶å®š APIã€‚";
      statusEl.className = "status success";
    });

    // input events
    [nameInput, phoneInput, addressInput, captchaInput, otpInput].forEach(el => {
      el.addEventListener("input", refreshSubmitState);
    });

    // init
    setPill(pillLiff, "neu", "LIFFï¼šåˆå§‹åŒ–ä¸­â€¦");
    setPill(pillClient, "neu", "Clientï¼šåˆ¤æ–·ä¸­â€¦");
    setPill(pillLogin, "neu", "Loginï¼šåˆ¤æ–·ä¸­â€¦");
    setPill(pillBind, "neu", "Bindï¼šæŸ¥è©¢ä¸­â€¦");

    // å…ˆç•« captchaï¼ˆè‹¥å¾Œé¢åˆ¤æ–·å·²ç¶å®šæœƒé–æ‰ï¼‰
    resetCaptcha();
    resetOtp();
    initAll();
  </script>
</body>
</html>
