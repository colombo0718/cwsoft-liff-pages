<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>åŠ å…¥æœƒå“¡ï½œé€²éšè¡ŒéŠ·æ–¹æ¡ˆ Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="style.css">
  <style>
    /* ä¸ä¾è³´ style.css çš„æœ€å°æ¨£å¼è£œå¼·ï¼ˆä½ å¯ç§»åˆ° style.cssï¼‰ */
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .mini-btn {
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: inherit;
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
    }
    .mini-btn:disabled { opacity: .5; cursor:not-allowed; }
    .pill {
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      font-size: 13px;
      opacity: .95;
    }
    .ok { border-color: rgba(0,255,140,.25); }
    .bad { border-color: rgba(255,80,80,.25); }
    .cap-wrap { display:flex; gap:10px; align-items:center; }
    #captchaCanvas {
      width: 140px; height: 48px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }
    .section-title {
      margin-top: 14px;
      font-weight: 800;
      opacity: .95;
      letter-spacing: .5px;
    }
    .helper {
      font-size: 13px;
      opacity: .8;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="card-header">
      <div class="dot"></div>
      <div class="title-group">
        <h1>åŠ å…¥æœƒå“¡</h1>
        <div class="subtitle">é€²éšè¡ŒéŠ·æ–¹æ¡ˆ Â· Line å®˜æ–¹å¸³è™Ÿç¶å®š</div>
      </div>
      <div class="badge">Demo</div>
    </div>

    <div class="hint">
      é€™é å¿…é ˆé€é LIFF é–‹å•Ÿã€‚é–‹å•Ÿå¾Œæœƒè‡ªå‹•æŠ“å–ä½¿ç”¨è€… Profileï¼Œä¸¦é¡¯ç¤º LIFF userIdã€‚<br>
      ï¼ˆæ³¨æ„ï¼šé€™å€‹ userId æ˜¯ LIFF/Provider çš„ï¼Œä¸ä¸€å®šç­‰æ–¼è©² OA webhook çš„ userIdï¼‰
    </div>

    <!-- LIFF ä½¿ç”¨è€…è³‡è¨Šé¡¯ç¤ºå€ -->
    <div class="preview" id="user-box" style="margin-top:12px;">
      <div class="preview-title">ğŸ‘¤ LIFF ä½¿ç”¨è€…è³‡è¨Š</div>
      <div id="user-body">ï¼ˆå°šæœªåˆå§‹åŒ– LIFFâ€¦ï¼‰</div>
    </div>

    <form id="member-form">
      <label>
        <div class="label-main">
          æ‰‹æ©Ÿè™Ÿç¢¼ <span class="required">*</span>
        </div>
        <input id="phone" type="tel" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š0912-345-678" required />
      </label>

      <label>
        <div class="label-main">
          å§“å <span class="required">*</span>
        </div>
        <input id="name" type="text" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" required />
      </label>

      <label>
        <div class="label-main">
          é€šè¨Šåœ°å€
        </div>
        <input id="address" type="text" placeholder="ä¾‹å¦‚ï¼šå°å—å¸‚æ±å€æˆåŠŸè·¯ 123 è™Ÿ" />
      </label>

      <label>
        <div class="label-main">
          å‚™è¨»
        </div>
        <textarea id="note" placeholder="ä¾‹å¦‚ï¼šå¸¸ç”¨åˆ†åº—ã€ç‰¹æ®Šéœ€æ±‚ã€ç”Ÿæ—¥ç­‰â€¦"></textarea>
      </label>

      <!-- é˜²æ©Ÿå™¨äººé©—è­‰ -->
      <div class="section-title">ğŸ›¡ï¸ é˜²æ©Ÿå™¨äººé©—è­‰</div>
      <div class="helper">è«‹è¼¸å…¥åœ–ç‰‡ä¸­çš„å››ä½æ•¸å­—ï¼ˆå…ˆæ±‚æœ‰ç‰ˆï¼šå‰ç«¯éš¨æ©Ÿç”¢ç”Ÿï¼‰ã€‚</div>

      <div class="row" style="margin-top:10px;">
        <div class="cap-wrap">
          <canvas id="captchaCanvas" width="280" height="96"></canvas>
          <button type="button" class="mini-btn" id="captchaRefreshBtn">ğŸ”„ æ›ä¸€å¼µ</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <input id="captchaInput" type="text" inputmode="numeric" maxlength="4" placeholder="è¼¸å…¥å››ä½æ•¸å­—" style="flex:1; min-width: 200px;" />
        <button type="button" class="mini-btn" id="captchaVerifyBtn">âœ… é©—è­‰</button>
        <span class="pill bad" id="captchaState">å°šæœªé©—è­‰</span>
      </div>

      <!-- OTP é©—è­‰ -->
      <div class="section-title">ğŸ“² OTP ç°¡è¨Šé©—è­‰</div>
      <div class="helper">å…ˆæ±‚æœ‰ç‰ˆï¼šé»ã€Œå–å¾—é©—è­‰ç¢¼ã€æœƒåœ¨å‰ç«¯ç”¢ç”Ÿä¸€çµ„ OTPï¼ˆæœƒé¡¯ç¤ºåœ¨æç¤ºä¸­/consoleï¼‰ï¼Œå¾ŒçºŒå†æ›æˆå¾Œç«¯ç°¡è¨Š APIã€‚</div>

      <div class="row" style="margin-top:10px;">
        <button type="button" class="mini-btn" id="otpSendBtn" disabled>ğŸ“© å–å¾—é©—è­‰ç¢¼</button>
        <span class="pill bad" id="otpSendState">å°šæœªç™¼é€</span>
      </div>

      <div class="row" style="margin-top:10px;">
        <input id="otpInput" type="text" inputmode="numeric" maxlength="6" placeholder="è¼¸å…¥ 6 ä½ OTP" style="flex:1; min-width: 200px;" disabled />
        <button type="button" class="mini-btn" id="otpVerifyBtn" disabled>ğŸ” é€²è¡Œé©—è­‰</button>
        <span class="pill bad" id="otpVerifyState">å°šæœªé©—è­‰</span>
      </div>

      <button type="submit" class="btn" id="submitBtn" disabled style="margin-top:14px;">
        <span class="icon">âœ…</span>
        <span>é€å‡ºï¼Œå¯«å…¥ Line è¨Šæ¯</span>
      </button>
    </form>

    <div class="status" id="status"></div>

    <div class="preview" id="preview">
      <div class="preview-title">ğŸ“¨ é è¦½ï¼šé€åˆ° Line å°è©±çš„å…§å®¹</div>
      <div id="preview-body">ï¼ˆè«‹å…ˆè¼¸å…¥ä¸Šæ–¹è³‡æ–™â€¦ï¼‰</div>
    </div>

    <div class="env-warning" id="env-warning">
      âš ï¸ åµæ¸¬ä¸åˆ° LIFF ç’°å¢ƒæˆ–ä¸åœ¨ Line å…§é–‹å•Ÿã€‚<br>
      è«‹å¾ Line OA çš„ LIFF å…¥å£é–‹å•Ÿï¼Œæ‰èƒ½æŠ“åˆ° userId èˆ‡é€è¨Šæ¯ã€‚
    </div>
  </div>

  <script>
    const LIFF_ID = "2008039127-p7We0QWm"; // æ›æˆä½ çš„ LIFF ID

    const phoneInput = document.getElementById("phone");
    const nameInput = document.getElementById("name");
    const addressInput = document.getElementById("address");
    const noteInput = document.getElementById("note");
    const statusEl = document.getElementById("status");
    const previewBodyEl = document.getElementById("preview-body");
    const envWarningEl = document.getElementById("env-warning");
    const userBodyEl = document.getElementById("user-body");
    const form = document.getElementById("member-form");
    const submitBtn = document.getElementById("submitBtn");

    // Captcha
    const captchaCanvas = document.getElementById("captchaCanvas");
    const captchaRefreshBtn = document.getElementById("captchaRefreshBtn");
    const captchaInput = document.getElementById("captchaInput");
    const captchaVerifyBtn = document.getElementById("captchaVerifyBtn");
    const captchaState = document.getElementById("captchaState");

    // OTP
    const otpSendBtn = document.getElementById("otpSendBtn");
    const otpSendState = document.getElementById("otpSendState");
    const otpInput = document.getElementById("otpInput");
    const otpVerifyBtn = document.getElementById("otpVerifyBtn");
    const otpVerifyState = document.getElementById("otpVerifyState");

    let liffReady = false;
    let liffProfile = null;

    // Captcha/OTP state
    let captchaText = "";
    let captchaVerified = false;

    let otpCode = "";
    let otpSent = false;
    let otpVerified = false;
    let otpCooldownTimer = null;
    let otpCooldownSec = 0;

    function escapeHtml(s) {
      return (s ?? "").toString()
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function normalizePhone(phone) {
      return phone.replace(/[^\d]/g, "");
    }

    function setPill(el, ok, text) {
      el.textContent = text;
      el.classList.remove("ok", "bad");
      el.classList.add(ok ? "ok" : "bad");
    }

    function refreshSubmitState() {
      // é€å‡ºæ¢ä»¶ï¼šcaptchaVerified + otpVerified
      const enabled = captchaVerified && otpVerified;
      submitBtn.disabled = !enabled;

      // OTP çš„ã€Œå–å¾—ã€æ¢ä»¶ï¼šcaptchaVerifiedï¼ˆä¸”æ‰‹æ©Ÿæ ¼å¼OKï¼‰
      const phoneOk = normalizePhone(phoneInput.value.trim()).length >= 9;
      otpSendBtn.disabled = !(captchaVerified && phoneOk && otpCooldownSec === 0);
    }

    // ===== Captcha =====
    function randomDigits(n=4) {
      let s = "";
      for (let i=0;i<n;i++) s += Math.floor(Math.random()*10);
      return s;
    }

    function drawCaptcha() {
      captchaText = randomDigits(4);
      captchaVerified = false;
      setPill(captchaState, false, "å°šæœªé©—è­‰");
      captchaInput.value = "";

      const ctx = captchaCanvas.getContext("2d");
      const w = captchaCanvas.width;
      const h = captchaCanvas.height;

      // background
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle = "rgba(255,255,255,0.06)";
      ctx.fillRect(0,0,w,h);

      // noise dots
      for (let i=0;i<80;i++) {
        ctx.fillStyle = `rgba(255,255,255,${Math.random()*0.25})`;
        ctx.beginPath();
        ctx.arc(Math.random()*w, Math.random()*h, Math.random()*2.2, 0, Math.PI*2);
        ctx.fill();
      }

      // noise lines
      for (let i=0;i<6;i++) {
        ctx.strokeStyle = `rgba(255,255,255,${0.10 + Math.random()*0.25})`;
        ctx.lineWidth = 2 + Math.random()*2;
        ctx.beginPath();
        ctx.moveTo(Math.random()*w, Math.random()*h);
        ctx.bezierCurveTo(Math.random()*w, Math.random()*h, Math.random()*w, Math.random()*h, Math.random()*w, Math.random()*h);
        ctx.stroke();
      }

      // text
      ctx.save();
      ctx.font = "bold 54px ui-monospace, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.textBaseline = "middle";
      ctx.textAlign = "center";

      // slight rotation per char
      const chars = captchaText.split("");
      const startX = w/2 - 70;
      for (let i=0;i<chars.length;i++) {
        const x = startX + i*45;
        const y = h/2 + (Math.random()*10 - 5);
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate((Math.random()*0.35 - 0.175));
        ctx.fillText(chars[i], 0, 0);
        ctx.restore();
      }
      ctx.restore();

      // OTP gate reset
      otpCode = "";
      otpSent = false;
      otpVerified = false;
      setPill(otpSendState, false, "å°šæœªç™¼é€");
      setPill(otpVerifyState, false, "å°šæœªé©—è­‰");
      otpInput.value = "";
      otpInput.disabled = true;
      otpVerifyBtn.disabled = true;

      refreshSubmitState();
      updatePreview();
    }

    captchaRefreshBtn.addEventListener("click", drawCaptcha);

    captchaVerifyBtn.addEventListener("click", () => {
      const v = captchaInput.value.trim();
      if (v === captchaText) {
        captchaVerified = true;
        setPill(captchaState, true, "é©—è­‰æˆåŠŸ âœ…");
        // é–‹æ”¾ OTP å–å¾—
        refreshSubmitState();
        statusEl.textContent = "é˜²æ©Ÿå™¨äººé©—è­‰æˆåŠŸï¼Œå¯å–å¾— OTPã€‚";
        statusEl.className = "status success";
      } else {
        captchaVerified = false;
        setPill(captchaState, false, "é©—è­‰å¤±æ•— âŒ");
        statusEl.textContent = "åœ–å½¢é©—è­‰ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚";
        statusEl.className = "status error";
        drawCaptcha(); // å¤±æ•—ç›´æ¥æ›ä¸€å¼µï¼Œé¿å…æš´åŠ›çŒœ
      }
      updatePreview();
    });

    captchaInput.addEventListener("input", () => {
      if (captchaInput.value.trim().length === 4) {
        // è®“ä½¿ç”¨è€…å¯ä»¥æ›´å¿«æŒ‰
      }
    });

    // ===== OTP (Demo mock) =====
    function startOtpCooldown(sec=60) {
      otpCooldownSec = sec;
      otpSendBtn.disabled = true;
      otpSendBtn.textContent = `â³ è«‹ç¨å€™ (${otpCooldownSec}s)`;

      if (otpCooldownTimer) clearInterval(otpCooldownTimer);
      otpCooldownTimer = setInterval(() => {
        otpCooldownSec -= 1;
        if (otpCooldownSec <= 0) {
          clearInterval(otpCooldownTimer);
          otpCooldownTimer = null;
          otpCooldownSec = 0;
          otpSendBtn.textContent = "ğŸ“© å–å¾—é©—è­‰ç¢¼";
          refreshSubmitState();
          return;
        }
        otpSendBtn.textContent = `â³ è«‹ç¨å€™ (${otpCooldownSec}s)`;
      }, 1000);
    }

    function mockSendOtp() {
      otpCode = randomDigits(6);
      otpSent = true;
      otpVerified = false;

      setPill(otpSendState, true, "å·²ç™¼é€ âœ…");
      setPill(otpVerifyState, false, "å°šæœªé©—è­‰");

      otpInput.disabled = false;
      otpVerifyBtn.disabled = false;

      // Demoï¼šé¡¯ç¤ºæç¤ºï¼ˆä½ ä¹Ÿå¯ä»¥åª console.logï¼‰
      statusEl.textContent = `ã€Demoã€‘OTP å·²ç”¢ç”Ÿï¼š${otpCode}ï¼ˆä¹‹å¾Œæ¥å¾Œç«¯ç°¡è¨Šæ™‚ç§»é™¤ï¼‰`;
      statusEl.className = "status success";
      console.log("Demo OTP:", otpCode);

      startOtpCooldown(60);
      refreshSubmitState();
      updatePreview();
    }

    otpSendBtn.addEventListener("click", () => {
      const phone = normalizePhone(phoneInput.value.trim());
      const name = nameInput.value.trim();

      if (!captchaVerified) {
        statusEl.textContent = "è«‹å…ˆå®Œæˆé˜²æ©Ÿå™¨äººé©—è­‰ã€‚";
        statusEl.className = "status error";
        return;
      }
      if (!name) {
        statusEl.textContent = "è«‹å…ˆå¡«å¯«å§“åã€‚";
        statusEl.className = "status error";
        return;
      }
      if (phone.length < 9) {
        statusEl.textContent = "è«‹å…ˆå¡«å¯«æ­£ç¢ºæ‰‹æ©Ÿè™Ÿç¢¼ã€‚";
        statusEl.className = "status error";
        return;
      }

      // TODO(ä¹‹å¾Œ)ï¼šæ”¹æˆå‘¼å«å¾Œç«¯ç™¼é€ OTP
      // await fetch("/api/otp/send", {method:"POST", body: JSON.stringify({phone, name})})
      mockSendOtp();
    });

    otpVerifyBtn.addEventListener("click", () => {
      const v = otpInput.value.trim();
      if (!otpSent) {
        statusEl.textContent = "è«‹å…ˆå–å¾—é©—è­‰ç¢¼ã€‚";
        statusEl.className = "status error";
        return;
      }
      if (v === otpCode) {
        otpVerified = true;
        setPill(otpVerifyState, true, "é©—è­‰æˆåŠŸ âœ…");
        statusEl.textContent = "OTP é©—è­‰æˆåŠŸï¼Œå¯ä»¥é€å‡ºã€‚";
        statusEl.className = "status success";
      } else {
        otpVerified = false;
        setPill(otpVerifyState, false, "é©—è­‰å¤±æ•— âŒ");
        statusEl.textContent = "OTP éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚";
        statusEl.className = "status error";
      }
      refreshSubmitState();
      updatePreview();
    });

    otpInput.addEventListener("input", () => {
      if (otpInput.value.trim().length === 6 && !otpVerifyBtn.disabled) {
        // ä½¿ç”¨è€…å¯è‡ªè¡ŒæŒ‰ã€Œé€²è¡Œé©—è­‰ã€
      }
    });

    // ===== LIFF + Message =====
    function buildMessageText() {
      const phone = normalizePhone(phoneInput.value.trim());
      const name = nameInput.value.trim();
      const address = addressInput.value.trim();
      const note = noteInput.value.trim();
      const otp = otpInput.value.trim();

      let lines = [];
      lines.push("GTB|BIND_MEMBER|v=1");
      if (liffProfile?.userId) lines.push("LIFF_userIdï¼š" + liffProfile.userId);

      // é©—è­‰ç‹€æ…‹ï¼ˆæ–¹ä¾¿ webhook/äººå·¥åˆ¤æ–·ï¼‰
      lines.push("Captchaï¼š" + (captchaVerified ? "OK" : "NO"));
      lines.push("OTP_Verifiedï¼š" + (otpVerified ? "OK" : "NO"));

      if (name)   lines.push("å§“åï¼š" + name);
      if (phone)  lines.push("æ‰‹æ©Ÿï¼š" + phone);
      if (address) lines.push("åœ°å€ï¼š" + address);
      if (note)   lines.push("å‚™è¨»ï¼š" + note);

      // å…ˆæ±‚æœ‰ï¼šæŠŠ OTP ä¸€èµ·é€å› webhookï¼ˆå¾Œé¢ä¸Šæ­£å¼ç‰ˆæœƒæ‹¿æ‰ï¼Œæ”¹ HTTP POSTï¼‰
      if (otp) lines.push("OTPï¼š" + otp);

      return lines.join("\n");
    }

    function updatePreview() {
      const text = buildMessageText();
      previewBodyEl.textContent = text || "ï¼ˆè«‹å…ˆè¼¸å…¥ä¸Šæ–¹è³‡æ–™â€¦ï¼‰";
    }

    phoneInput.addEventListener("input", () => { refreshSubmitState(); updatePreview(); });
    nameInput.addEventListener("input",  () => { refreshSubmitState(); updatePreview(); });
    addressInput.addEventListener("input", updatePreview);
    noteInput.addEventListener("input", updatePreview);

    function renderUserBox(profile, extra = {}) {
      const rows = [];
      rows.push(`<div>âœ… LIFF å·²åˆå§‹åŒ–ï¼š<b>${liffReady ? "æ˜¯" : "å¦"}</b></div>`);
      rows.push(`<div>ğŸ“± isInClientï¼š<b>${window.liff?.isInClient?.() ? "æ˜¯" : "å¦"}</b></div>`);
      rows.push(`<div>ğŸ” isLoggedInï¼š<b>${window.liff?.isLoggedIn?.() ? "æ˜¯" : "å¦"}</b></div>`);

      if (profile) {
        rows.push("<hr style='opacity:.15;margin:10px 0;'>");
        rows.push(`<div>userIdï¼š<code>${escapeHtml(profile.userId)}</code></div>`);
        rows.push(`<div>displayNameï¼š<b>${escapeHtml(profile.displayName)}</b></div>`);
        rows.push(`<div>statusMessageï¼š${escapeHtml(profile.statusMessage || "ï¼ˆç©ºï¼‰")}</div>`);
        if (profile.pictureUrl) {
          rows.push(`<div style="margin-top:8px;"><img src="${escapeHtml(profile.pictureUrl)}" alt="avatar" style="width:64px;height:64px;border-radius:12px;object-fit:cover;"></div>`);
        }
      }

      if (extra.idTokenSub) {
        rows.push("<hr style='opacity:.15;margin:10px 0;'>");
        rows.push(`<div>ID Token subï¼š<code>${escapeHtml(extra.idTokenSub)}</code></div>`);
      }

      userBodyEl.innerHTML = rows.join("");
    }

    async function initLiff() {
      if (!window.liff) {
        envWarningEl.style.display = "block";
        userBodyEl.textContent = "ï¼ˆæ‰¾ä¸åˆ° LIFF SDKï¼‰";
        return;
      }

      try {
        await liff.init({ liffId: LIFF_ID });
        liffReady = true;

        if (!liff.isInClient()) {
          envWarningEl.style.display = "block";
        }

        if (!liff.isLoggedIn()) {
          renderUserBox(null);
          statusEl.textContent = "å°šæœªç™»å…¥ LINEï¼ˆå¤–éƒ¨ç€è¦½å™¨å¸¸è¦‹ï¼‰ï¼Œå³å°‡å°å‘ç™»å…¥â€¦";
          statusEl.className = "status";
          liff.login();
          return;
        }

        liffProfile = await liff.getProfile();

        let idTokenSub = "";
        try {
          const decoded = liff.getDecodedIDToken?.();
          idTokenSub = decoded?.sub || "";
        } catch (_) {}

        renderUserBox(liffProfile, { idTokenSub });
        updatePreview();

        statusEl.textContent = "LIFF åˆå§‹åŒ–å®Œæˆï¼Œå·²å–å¾—ä½¿ç”¨è€…è³‡è¨Šã€‚";
        statusEl.className = "status success";
      } catch (err) {
        console.error("LIFF åˆå§‹åŒ–å¤±æ•—ï¼š", err);
        statusEl.textContent = "LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ LIFF ID æˆ– LIFF è¨­å®šã€‚";
        statusEl.className = "status error";
        envWarningEl.style.display = "block";
        renderUserBox(null);
      }
    }

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      statusEl.textContent = "";
      statusEl.className = "status";

      const phone = normalizePhone(phoneInput.value.trim());
      const name = nameInput.value.trim();

      if (!phone || !name) {
        statusEl.textContent = "è«‹è‡³å°‘å¡«å¯«ã€Œå§“åã€èˆ‡ã€Œæ‰‹æ©Ÿè™Ÿç¢¼ã€ã€‚";
        statusEl.className = "status error";
        return;
      }

      if (!captchaVerified) {
        statusEl.textContent = "è«‹å…ˆå®Œæˆé˜²æ©Ÿå™¨äººé©—è­‰ã€‚";
        statusEl.className = "status error";
        return;
      }

      if (!otpVerified) {
        statusEl.textContent = "è«‹å…ˆå®Œæˆ OTP é©—è­‰ã€‚";
        statusEl.className = "status error";
        return;
      }

      const text = buildMessageText();
      updatePreview();

      if (!liffReady || !liff.isInClient()) {
        statusEl.textContent = "Demo æ¨¡å¼ï¼šç›®å‰ä¸åœ¨ Line å…§é–‹å•Ÿï¼Œç„¡æ³•çœŸçš„é€è¨Šæ¯ï¼ˆä½†å·²é¡¯ç¤ºé è¦½ï¼‰ã€‚";
        statusEl.className = "status success";
        return;
      }

      try {
        await liff.sendMessages([{ type: "text", text }]);
        statusEl.textContent = "å·²é€å‡ºè¨Šæ¯åˆ° Line å°è©±è¦–çª—ï¼ˆå«é©—è­‰ç‹€æ…‹/OTP/LIFF userId æ–¹ä¾¿ webhook ç«¯å…ˆè·‘é€šï¼‰ã€‚";
        statusEl.className = "status success";
      } catch (err) {
        console.error("é€è¨Šæ¯å¤±æ•—ï¼š", err);
        statusEl.textContent = "é€è¨Šæ¯å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
        statusEl.className = "status error";
      }
    });

    // ===== Init =====
    updatePreview();
    drawCaptcha();        // å…ˆç”¢ç”Ÿä¸€å¼µåœ–å½¢é©—è­‰ç¢¼
    refreshSubmitState(); // åˆå§‹åŒ–æŒ‰éˆ•ç‹€æ…‹
    initLiff();           // åˆå§‹åŒ– LIFF
  </script>
</body>
</html>
