<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç¶å®šæœƒå“¡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="style.css">
  <style>
    /* åªè£œæœ€å°‘é‡çš„æ’ç‰ˆï¼ˆä½ ä¹Ÿå¯ä»¥æ¬é€² style.cssï¼‰ */
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.15); font-size:13px; opacity:.95; }
    .pill.ok { background: rgba(46, 204, 113, .18); border-color: rgba(46,204,113,.35); }
    .pill.bad { background: rgba(231, 76, 60, .18); border-color: rgba(231,76,60,.35); }
    .mini { font-size:12px; opacity:.8; line-height:1.4; }
    .section { margin-top:14px; padding-top:14px; border-top:1px solid rgba(255,255,255,.08); }
    .btn.small { padding:10px 12px; border-radius:12px; font-size:14px; }
    .captchaBox { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    canvas { border-radius:12px; border:1px solid rgba(255,255,255,.15); background: rgba(0,0,0,.15); }
    input[disabled], button[disabled] { opacity:.5; filter:grayscale(.2); cursor:not-allowed; }
  </style>
</head>

<body>
  <div class="card">
    <div class="card-header">
      <div class="dot"></div>
      <div class="title-group">
        <h1>ç¶å®šæœƒå“¡</h1>
        <div class="subtitle">Line å®˜æ–¹å¸³è™Ÿç¶å®š</div>
      </div>
      <div class="badge">Demo</div>
    </div>

    <!-- LIFF ç‹€æ…‹ + ä½¿ç”¨è€…è³‡è¨Š -->
    <div class="preview" style="margin-top:12px;">
      <div class="preview-title">ğŸ‘¤ ä½¿ç”¨è€…è³‡è¨Š</div>

      <div class="row" style="margin:8px 0 10px;">
        <span class="pill" id="pill-liff">LIFFï¼šåˆå§‹åŒ–ä¸­â€¦</span>
        <span class="pill" id="pill-client">Clientï¼šåˆ¤æ–·ä¸­â€¦</span>
        <span class="pill" id="pill-login">Loginï¼šåˆ¤æ–·ä¸­â€¦</span>
      </div>

      <div id="user-body" class="mini">ï¼ˆå°šæœªå–å¾—ä½¿ç”¨è€…è³‡æ–™ï¼‰</div>
    </div>

    <!-- è¡¨å–®ï¼šå§“å â†’ é›»è©± â†’ åœ°å€ -->
    <form id="member-form" class="section">
      <label>
        <div class="label-main">å§“å <span class="required">*</span></div>
        <input id="name" type="text" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" required />
      </label>

      <label>
        <div class="label-main">æ‰‹æ©Ÿè™Ÿç¢¼ <span class="required">*</span></div>
        <input id="phone" type="tel" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š0912-345-678" required />
      </label>

      <label>
        <div class="label-main">é€šè¨Šåœ°å€</div>
        <input id="address" type="text" placeholder="ä¾‹å¦‚ï¼šå°å—å¸‚æ±å€æˆåŠŸè·¯ 123 è™Ÿ" />
      </label>

      <!-- é˜²æ©Ÿå™¨äººé©—è­‰ -->
      <div class="section">
        <div class="label-main">ğŸ›¡ï¸ é˜²æ©Ÿå™¨äººé©—è­‰</div>
        <div class="mini" style="margin:6px 0 10px;">è«‹è¼¸å…¥åœ–ç‰‡ä¸­çš„ 4 ä½æ•¸å­—ï¼ˆå…ˆæ±‚æœ‰ç‰ˆï¼šå‰ç«¯éš¨æ©Ÿç”¢ç”Ÿï¼‰</div>

        <div class="captchaBox">
          <canvas id="captchaCanvas" width="160" height="56" aria-label="captcha"></canvas>
          <button type="button" class="btn small" id="btn-captcha-refresh">æ›ä¸€å¼µ</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <input id="captchaInput" type="text" inputmode="numeric" maxlength="4" placeholder="è¼¸å…¥å››ä½æ•¸å­—" style="flex:1; min-width:160px;">
          <button type="button" class="btn small" id="btn-captcha-verify">é©—è­‰</button>
          <span class="pill bad" id="pill-captcha">å°šæœªé©—è­‰</span>
        </div>
      </div>

      <!-- OTP ç°¡è¨Šé©—è­‰ï¼ˆå…ˆæ±‚æœ‰ï¼šå‰ç«¯ç”¢ç”Ÿ OTPï¼‰ -->
      <div class="section">
        <div class="label-main">ğŸ“± OTP ç°¡è¨Šé©—è­‰</div>
        <div class="mini" style="margin:6px 0 10px;">å…ˆæ±‚æœ‰ç‰ˆï¼šé»ã€Œå–å¾—é©—è­‰ç¢¼ã€æœƒåœ¨ç•«é¢æç¤º/console ç”¢ç”Ÿä¸€çµ„ OTPï¼ˆä¹‹å¾Œå†æ›æˆå¾Œç«¯ç°¡è¨Š APIï¼‰</div>

        <div class="row" style="margin-bottom:10px;">
          <button type="button" class="btn small" id="btn-otp-send">å–å¾—é©—è­‰ç¢¼</button>
          <span class="pill bad" id="pill-otp-send">å°šæœªç™¼é€</span>
        </div>

        <div class="row">
          <input id="otpInput" type="text" inputmode="numeric" maxlength="6" placeholder="è¼¸å…¥ 6 ä½ OTP" style="flex:1; min-width:180px;">
          <button type="button" class="btn small" id="btn-otp-verify">é€²è¡Œé©—è­‰</button>
          <span class="pill bad" id="pill-otp">å°šæœªé©—è­‰</span>
        </div>

        <div class="mini" id="otpHint" style="margin-top:8px; display:none;"></div>
      </div>

      <!-- é€å‡º -->
      <div class="section">
        <button type="submit" class="btn" id="btn-submit" disabled>
          <span class="icon">âœ…</span>
          <span>é€å‡ºè³‡æ–™</span>
        </button>
        <div class="status" id="status"></div>
      </div>
    </form>
  </div>

  <script>
    const LIFF_ID = "2008039127-p7We0QWm"; // æ›æˆä½ çš„ LIFF ID

    const nameInput = document.getElementById("name");
    const phoneInput = document.getElementById("phone");
    const addressInput = document.getElementById("address");
    const statusEl = document.getElementById("status");
    const form = document.getElementById("member-form");

    const pillLiff = document.getElementById("pill-liff");
    const pillClient = document.getElementById("pill-client");
    const pillLogin = document.getElementById("pill-login");
    const userBodyEl = document.getElementById("user-body");

    const captchaCanvas = document.getElementById("captchaCanvas");
    const btnCaptchaRefresh = document.getElementById("btn-captcha-refresh");
    const captchaInput = document.getElementById("captchaInput");
    const btnCaptchaVerify = document.getElementById("btn-captcha-verify");
    const pillCaptcha = document.getElementById("pill-captcha");

    const btnOtpSend = document.getElementById("btn-otp-send");
    const pillOtpSend = document.getElementById("pill-otp-send");
    const otpInput = document.getElementById("otpInput");
    const btnOtpVerify = document.getElementById("btn-otp-verify");
    const pillOtp = document.getElementById("pill-otp");
    const otpHint = document.getElementById("otpHint");

    const btnSubmit = document.getElementById("btn-submit");

    let liffReady = false;
    let liffProfile = null;

    // å…ˆæ±‚æœ‰ï¼šcaptcha/otp éƒ½åœ¨å‰ç«¯é©—
    let captchaCode = "";
    let captchaVerified = false;

    let otpCode = "";
    let otpSentAt = 0;
    let otpVerified = false;

    // å…ˆæ±‚æœ‰ï¼šOTP é©—è­‰æˆåŠŸå¾Œç”Ÿæˆ tokenï¼ˆæ­£å¼ç‰ˆæ”¹æˆå¾Œç«¯å›å‚³ bind_tokenï¼‰
    let bindToken = "";

    function setPill(el, ok, text) {
      el.classList.remove("ok", "bad");
      el.classList.add(ok ? "ok" : "bad");
      el.textContent = text;
    }

    function escapeHtml(s) {
      return (s ?? "").toString()
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function normalizePhone(phone) {
      // åªç•™æ•¸å­—
      return (phone || "").replace(/\D/g, "");
    }

    function canSubmit() {
      const nameOk = !!nameInput.value.trim();
      const phoneOk = normalizePhone(phoneInput.value.trim()).length >= 8; // å…ˆæ±‚æœ‰ï¼šå¯¬é¬†
      const liffOk = liffReady && window.liff && liff.isInClient();
      return liffOk && nameOk && phoneOk && captchaVerified && otpVerified && !!bindToken;
    }

    function refreshSubmitState() {
      btnSubmit.disabled = !canSubmit();
    }

    // -------------------------
    // CAPTCHA
    // -------------------------
    function randomDigits(n) {
      let out = "";
      for (let i = 0; i < n; i++) out += Math.floor(Math.random() * 10);
      return out;
    }

    function drawCaptcha(code) {
      const ctx = captchaCanvas.getContext("2d");
      const w = captchaCanvas.width;
      const h = captchaCanvas.height;

      // èƒŒæ™¯
      ctx.clearRect(0, 0, w, h);
      ctx.fillStyle = "rgba(255,255,255,0.06)";
      ctx.fillRect(0, 0, w, h);

      // é›œç·š
      for (let i = 0; i < 10; i++) {
        ctx.strokeStyle = `rgba(255,255,255,${0.08 + Math.random() * 0.12})`;
        ctx.beginPath();
        ctx.moveTo(Math.random() * w, Math.random() * h);
        ctx.lineTo(Math.random() * w, Math.random() * h);
        ctx.stroke();
      }

      // æ–‡å­—
      ctx.font = "bold 34px system-ui, -apple-system, Segoe UI, Roboto";
      ctx.textBaseline = "middle";
      for (let i = 0; i < code.length; i++) {
        const ch = code[i];
        const x = 18 + i * 32;
        const y = h / 2 + (Math.random() * 6 - 3);
        const rot = (Math.random() * 0.35 - 0.175);
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(rot);
        ctx.fillStyle = "rgba(255,255,255,0.92)";
        ctx.fillText(ch, 0, 0);
        ctx.restore();
      }

      // é›œé»
      for (let i = 0; i < 60; i++) {
        ctx.fillStyle = `rgba(255,255,255,${0.05 + Math.random() * 0.12})`;
        ctx.fillRect(Math.random() * w, Math.random() * h, 1.5, 1.5);
      }
    }

    function resetCaptcha() {
      captchaCode = randomDigits(4);
      captchaVerified = false;
      captchaInput.value = "";
      drawCaptcha(captchaCode);
      setPill(pillCaptcha, false, "å°šæœªé©—è­‰");
      refreshSubmitState();
    }

    btnCaptchaRefresh.addEventListener("click", resetCaptcha);

    btnCaptchaVerify.addEventListener("click", () => {
      const v = (captchaInput.value || "").trim();
      if (v === captchaCode) {
        captchaVerified = true;
        setPill(pillCaptcha, true, "é©—è­‰é€šé âœ…");
      } else {
        captchaVerified = false;
        setPill(pillCaptcha, false, "éŒ¯èª¤ï¼Œè«‹é‡è©¦");
        resetCaptcha();
      }
      refreshSubmitState();
    });

    // -------------------------
    // OTPï¼ˆå…ˆæ±‚æœ‰ï¼šå‰ç«¯ç”¢ç”Ÿï¼‰
    // -------------------------
    function resetOtp() {
      otpCode = "";
      otpSentAt = 0;
      otpVerified = false;
      bindToken = "";

      otpInput.value = "";
      otpHint.style.display = "none";
      otpHint.textContent = "";

      setPill(pillOtpSend, false, "å°šæœªç™¼é€");
      setPill(pillOtp, false, "å°šæœªé©—è­‰");
      refreshSubmitState();
    }

    btnOtpSend.addEventListener("click", async () => {
      // å…ˆæ±‚æœ‰ï¼šä¸å¸¶åƒæ•¸ï¼Œç›´æ¥å«å¾Œç«¯ /otp å¯„ç°¡è¨Šåˆ°ä½ é è¨­çš„æ‰‹æ©Ÿ
      setPill(pillOtpSend, false, "ç™¼é€ä¸­â€¦");
      btnOtpSend.disabled = true;

      try {
        const res = await fetch("https://cwsoft.leaflune.org/otp", {
          method: "GET",
          mode: "cors",
          cache: "no-store",
        });

        // å¾Œç«¯å»ºè­°å› JSONï¼š{ ok: true, ... }
        const data = await res.json().catch(() => ({}));

        if (!res.ok || data.ok === false) {
          throw new Error(data.error || `HTTP ${res.status}`);
        }

        setPill(pillOtpSend, true, "å·²è«‹æ±‚ç™¼é€ âœ…");

        otpHint.style.display = "block";
        otpHint.textContent = "å·²å‘å¾Œç«¯è«‹æ±‚ç™¼é€ OTP ç°¡è¨Šï¼Œè«‹æŸ¥çœ‹æ‰‹æ©Ÿæ”¶ä»¶ã€‚";

        // å…ˆæ±‚æœ‰ï¼šå…ˆä¸åš verifyï¼ˆç­‰ä½ åš /otp/verifyï¼‰
        setPill(pillOtp, false, "å°šæœªé©—è­‰");
        btnOtpVerify.disabled = true;   // å…ˆé–ä½
        otpInput.disabled = true;       // å…ˆé–ä½

      } catch (err) {
        console.error("call /otp failed:", err);
        setPill(pillOtpSend, false, "ç™¼é€å¤±æ•—");
        otpHint.style.display = "block";
        otpHint.textContent = "å‘¼å« OTP æœå‹™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æª¢æŸ¥å¾Œç«¯/CORSã€‚";
      } finally {
        btnOtpSend.disabled = false;
        refreshSubmitState();
      }
    });

    btnOtpVerify.addEventListener("click", () => {
      const v = (otpInput.value || "").trim();
      if (!otpCode) {
        setPill(pillOtp, false, "è«‹å…ˆå–å¾—é©—è­‰ç¢¼");
        return;
      }

      // ç°¡å–®æœ‰æ•ˆæœŸï¼ˆå…ˆæ±‚æœ‰ï¼‰ï¼š5 åˆ†é˜
      const expired = (Date.now() - otpSentAt) > 5 * 60 * 1000;
      if (expired) {
        setPill(pillOtp, false, "å·²éæœŸï¼Œè«‹é‡ç™¼");
        resetOtp();
        return;
      }

      if (v === otpCode) {
        otpVerified = true;
        setPill(pillOtp, true, "é©—è­‰æˆåŠŸ âœ…");

        // å…ˆæ±‚æœ‰ï¼šOTP æˆåŠŸå¾Œç”¢ç”Ÿ tokenï¼ˆæ­£å¼ç‰ˆï¼šå¾Œç«¯å› bind_tokenï¼‰
        bindToken = `DEMO_${Date.now()}_${Math.random().toString(16).slice(2, 10)}`;

      } else {
        otpVerified = false;
        setPill(pillOtp, false, "éŒ¯èª¤ï¼Œè«‹é‡è©¦");
      }
      refreshSubmitState();
    });

    // -------------------------
    // Message Format: [BindMember]
    // -------------------------
    function buildBindMessageText() {
      const name = nameInput.value.trim();
      const phone = normalizePhone(phoneInput.value.trim());
      const address = addressInput.value.trim();

      const lines = [];
      lines.push("[BindMember]");
      lines.push(`token:${bindToken || ""}`);
      lines.push(`name:${name}`);
      lines.push(`phone:${phone}`);
      lines.push(`address:${address}`);
      return lines.join("\n");
    }

    // -------------------------
    // LIFF init
    // -------------------------
    function getOaIdFromUrl() {
      const qs = new URLSearchParams(location.search);
      return qs.get("oaid") || "";
    }

    function renderUser(profile) {
      const oaid = getOaIdFromUrl();

      const rows = [];
      rows.push(`<div>oaidï¼š<code>${escapeHtml(oaid || "ï¼ˆæœªæä¾›ï¼‰")}</code></div>`);

      if (!profile) {
        rows.push(`<div>uidï¼š<code>ï¼ˆå°šæœªå–å¾—ï¼‰</code></div>`);
        userBodyEl.innerHTML = rows.join("");
        return;
      }

      rows.push(`<div>displayNameï¼š<b>${escapeHtml(profile.displayName)}</b></div>`);
      rows.push(`<div>uidï¼š<code>${escapeHtml(profile.userId)}</code></div>`);

      userBodyEl.innerHTML = rows.join("");
    }

    async function initLiff() {
      if (!window.liff) {
        setPill(pillLiff, false, "LIFFï¼šæ‰¾ä¸åˆ° SDK");
        setPill(pillClient, false, "Clientï¼šæœªçŸ¥");
        setPill(pillLogin, false, "Loginï¼šæœªçŸ¥");
        return;
      }

      try {
        await liff.init({ liffId: LIFF_ID });
        liffReady = true;

        setPill(pillLiff, true, "LIFFï¼šå·²åˆå§‹åŒ– âœ…");
        setPill(pillClient, liff.isInClient(), `Clientï¼š${liff.isInClient() ? "æ˜¯" : "å¦"}`);

        if (!liff.isLoggedIn()) {
          setPill(pillLogin, false, "Loginï¼šæœªç™»å…¥");
          // å¤–éƒ¨ç€è¦½å™¨æœƒéœ€è¦ç™»å…¥ï¼›åœ¨ LINE å…§é€šå¸¸å·²ç™»å…¥
          liff.login();
          return;
        }

        setPill(pillLogin, true, "Loginï¼šå·²ç™»å…¥ âœ…");

        liffProfile = await liff.getProfile();
        renderUser(liffProfile);

        // ä½ èªªã€Œä½¿ç”¨è€…è³‡æ–™å°±æŠŠå§“åç›´æ¥å¯«é€²å»ã€â†’ è‡ªå‹•å¸¶ displayName
        if (!nameInput.value.trim() && liffProfile?.displayName) {
          nameInput.value = liffProfile.displayName;
        }

        statusEl.textContent = "";
        statusEl.className = "status";

      } catch (err) {
        console.error("LIFF init failed:", err);
        setPill(pillLiff, false, "LIFFï¼šåˆå§‹åŒ–å¤±æ•—");
        setPill(pillClient, false, "Clientï¼šæœªçŸ¥");
        setPill(pillLogin, false, "Loginï¼šæœªçŸ¥");
        statusEl.textContent = "LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ LIFF è¨­å®šã€‚";
        statusEl.className = "status error";
      } finally {
        refreshSubmitState();
      }
    }

    // -------------------------
    // Submit -> sendMessages -> webhook
    // -------------------------
form.addEventListener("submit", async (event) => {
  event.preventDefault();

  statusEl.textContent = "";
  statusEl.className = "status";

  statusEl.textContent = "ç›®å‰ç‰ˆæœ¬ï¼šä¸é€ Line è¨Šæ¯ã€‚å·²å®Œæˆ OTP å–å¾—æµç¨‹ï¼ˆä¸‹ä¸€æ­¥å†æ¥ http post ç¶å®šï¼‰ã€‚";
  statusEl.className = "status success";
});

    // ä»»ä¸€è¼¸å…¥æ”¹å‹•æ™‚ï¼Œåˆ·æ–° submit ç‹€æ…‹
    [nameInput, phoneInput, addressInput, captchaInput, otpInput].forEach(el => {
      el.addEventListener("input", refreshSubmitState);
    });

    // åˆå§‹åŒ–
    resetCaptcha();
    resetOtp();
    initLiff();
  </script>
</body>
</html>
