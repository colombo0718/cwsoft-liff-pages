<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç¶å®šæœƒå“¡</title>

  <!-- ä½ å·²ç§»é™¤ <style>ï¼šåªç”¨å¤–éƒ¨ CSS -->
  <link rel="stylesheet" href="./style.css" />

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>
  <div class="card">
    <div class="card-header">
      <div class="dot"></div>
      <div class="title-group">
        <h1>ç¶å®šæœƒå“¡</h1>
        <div class="subtitle">Line å®˜æ–¹å¸³è™Ÿç¶å®š</div>
      </div>
      <div class="badge">Demo</div>
    </div>

    <div class="hint">
      è«‹å¡«å¯«æœƒå“¡è³‡æ–™ä¸¦å®Œæˆé©—è­‰ã€‚<br />
      <span class="hintline">â€» ç³»çµ±æœƒè‡ªå‹•åˆ¤æ–·æ˜¯å¦å·²ç¶å®šï¼›å·²ç¶å®šå°‡é–å®šè¼¸å…¥ã€‚</span>
    </div>

    <form id="member-form" autocomplete="off">
      <!-- åŸºæœ¬è³‡æ–™ -->
      <label>
        <div class="label-main">å§“å <span class="required">*</span></div>
        <input id="name" type="text" placeholder="ä¾‹å¦‚ï¼šè¶™å£«è±ª" />
      </label>

      <label>
        <div class="label-main">æ‰‹æ©Ÿè™Ÿç¢¼ <span class="required">*</span></div>
        <input id="phone" type="tel" placeholder="ä¾‹å¦‚ï¼š0912-345-678" />
      </label>

      <label>
        <div class="label-main">é€šè¨Šåœ°å€</div>
        <input id="address" type="text" placeholder="ä¾‹å¦‚ï¼šå°å—å¸‚æ±å€æˆåŠŸè·¯ 123 è™Ÿ" />
      </label>

      <!-- CAPTCHA -->
      <div class="section">
        <div class="mini">ğŸ›¡ï¸ é˜²æ©Ÿå™¨äººé©—è­‰ï¼ˆåœ–ç‰‡ç¢¼ï¼‰</div>
        <div class="mini">è«‹è¼¸å…¥åœ–ç‰‡ä¸­çš„ 4 ä½æ•¸å­—ï¼ˆå…ˆæ±‚æœ‰ï¼šå‰ç«¯éš¨æ©Ÿç”¢ç”Ÿï¼‰</div>

        <div class="captchaBox" style="margin-top:10px;">
          <canvas id="captchaCanvas" width="170" height="56"></canvas>
          <button type="button" class="btn small" id="btn-captcha-refresh">æ›ä¸€å¼µ</button>
        </div>

        <!-- é€™è¡Œç”¨ inline flexï¼Œé¿å…ä¾è³´ .row -->
        <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <input id="captchaInput"
                 type="text"
                 inputmode="numeric"
                 placeholder="è¼¸å…¥å››ä½æ•¸å­—"
                 maxlength="4"
                 style="flex:1; min-width:180px;" />
          <button type="button" class="btn small" id="btn-captcha-verify">é©—è­‰åœ–ç‰‡ç¢¼</button>
          <span id="captchaVerifyStatus"
                style="font-size:12px; color:var(--muted); min-width:90px;">å°šæœªé©—è­‰</span>
        </div>
      </div>

      <!-- OTP -->
      <div class="section">
        <div class="mini">ğŸ“² OTP ç°¡è¨Šé©—è­‰</div>
        <div class="mini">
          é»ã€Œå–å¾— OTPã€æœƒå‘¼å«å¾Œç«¯ /otp ç™¼é€ç°¡è¨Šï¼ˆç›®å‰å…ˆæ±‚æœ‰ï¼šverify å…ˆç”¨æ ¼å¼åˆ¤æ–·ï¼‰ã€‚
        </div>

        <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button type="button" class="btn small" id="btn-otp-send">å–å¾— OTP</button>
          <span id="otpSendStatus" style="font-size:12px; color:var(--muted); min-width:120px;">å°šæœªç™¼é€</span>
        </div>

        <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <input id="otpInput"
                 type="text"
                 inputmode="numeric"
                 placeholder="è¼¸å…¥ 6 ä½ OTP"
                 maxlength="6"
                 style="flex:1; min-width:180px;" />
          <button type="button" class="btn small" id="btn-otp-verify">é©—è­‰ OTP</button>
          <span id="otpVerifyStatus" style="font-size:12px; color:var(--muted); min-width:90px;">å°šæœªé©—è­‰</span>
        </div>
      </div>

      <!-- é€å‡º -->
      <div class="section">
        <button type="submit" class="btn" id="btn-submit" disabled>
          <span class="icon">âœ…</span>
          <span>é€å‡ºè³‡æ–™</span>
        </button>

        <!-- é€™è£¡åªæ”¾ã€Œé é¢ç´šã€è¨Šæ¯ï¼šLIFF/ç¶å®šé–å®š/å¾Œç«¯éŒ¯èª¤ï¼Œä¸æ”¾å„æŒ‰éˆ•çµæœ -->
        <div class="status" id="status"></div>
      </div>

      <!-- Debug terminalï¼šå·¥ç¨‹ç”¨ -->
      <div class="section">
        <div class="mini">Debugï¼ˆå·¥ç¨‹ç”¨ï¼‰</div>
        <pre id="debug"
             style="margin:8px 0 0; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.18); max-height:180px; overflow:auto;"
        >[debug] boot...</pre>
      </div>
    </form>
  </div>
  <script src="./core.js"></script>
  <script src="./captcha.js"></script>
  <script>
    // ====== Config ======
    const LIFF_ID = "2008039127-p7We0QWm"; // ä½ çš„ LIFF ID
    const API_OA_LOOKUP = "https://cwsoft.leaflune.org/sqlgate/oa_lookup";
    const API_IS_BIND   = "https://cwsoft.leaflune.org/sqlgate/is_bind_member";
    const API_OTP       = "https://cwsoft.leaflune.org/otp";
    const API_BIND      = "https://cwsoft.leaflune.org/bind";
    // TODO: ä¹‹å¾Œæ¥çœŸæ­£ç¶å®š API
    // const API_BIND     = "https://cwsoft.leaflune.org/sqlgate/bind_member";

    // å…ˆæ±‚æœ‰ï¼šä½ ä¹‹å¾Œæœƒæ›æˆå¾Œç«¯çš„ä¸€æ¬¡æ€§ token
    let bindToken = "DUMMY_TOKEN";

    // // ====== DOM ======
    // const $ = (id) => document.getElementById(id);

    // const form = $("member-form");
    // const nameInput = $("name");
    // const phoneInput = $("phone");
    // const addressInput = $("address");

    // const captchaCanvas = $("captchaCanvas");
    // const btnCaptchaRefresh = $("btn-captcha-refresh");
    // const captchaInput = $("captchaInput");
    // const btnCaptchaVerify = $("btn-captcha-verify");
    // const captchaVerifyStatus = $("captchaVerifyStatus");

    // const btnOtpSend = $("btn-otp-send");
    // const otpSendStatus = $("otpSendStatus");
    // const otpInput = $("otpInput");
    // const btnOtpVerify = $("btn-otp-verify");
    // const otpVerifyStatus = $("otpVerifyStatus");

    // const btnSubmit = $("btn-submit");
    // const statusEl = $("status");
    // const debugEl = $("debug");

    // // ====== State ======
    // let oaid = "";
    // let dbName = "";
    // let liffReady = false;
    // let liffProfile = null;

    // let captchaCode = "";
    // let captchaVerified = false;

    // let otpVerified = false;

    // let isBound = false;
    // let memberNo = null;
    // let bindId = null;

    // // ====== Utils ======
    // function dbg(line) {
    //   const t = new Date().toISOString().slice(11, 19); // HH:MM:SS
    //   debugEl.textContent += `\n[${t}] ${line}`;
    //   debugEl.scrollTop = debugEl.scrollHeight;
    // }

    // function setStatus(text, type) {
    //   statusEl.className = "status" + (type ? " " + type : "");
    //   statusEl.textContent = text || "";
    // }

    // function setInline(el, text, type) {
    //   el.textContent = text;
    //   // ä¸æ fancy pillï¼šåªç”¨é¡è‰²å€åˆ†
    //   if (type === "ok") el.style.color = "#bbf7d0";
    //   else if (type === "bad") el.style.color = "#fecaca";
    //   else el.style.color = "var(--muted)";
    // }

    // function normalizePhone(raw) {
    //   return String(raw || "").trim().replaceAll(" ", "").replaceAll("-", "");
    // }

    // function getOaIdFromUrl() {
    //   const u = new URL(location.href);
    //   return (u.searchParams.get("oaid") || "").trim();
    // }

    // function lockAllUI() {
    //   [nameInput, phoneInput, addressInput, captchaInput, otpInput].forEach(el => el.disabled = true);
    //   [btnCaptchaRefresh, btnCaptchaVerify, btnOtpSend, btnOtpVerify, btnSubmit].forEach(el => el.disabled = true);
    // }

    // function dbLooksOk(db) {
    //   if (!db) return false;
    //   return !db.includes("æŸ¥ç„¡") && !db.includes("å¤±æ•—") && !db.includes("æœªæä¾›");
    // }

    // function canSubmit() {
    //   const nameOk = nameInput.value.trim().length > 0;
    //   const phoneOk = normalizePhone(phoneInput.value).length >= 10; // å…ˆæ±‚æœ‰
    //   const liffOk = liffReady && window.liff && liff.isLoggedIn() && liffProfile?.userId;
    //   const oaOk = !!oaid && dbLooksOk(dbName);
    //   return !!liffOk && nameOk && phoneOk && captchaVerified && otpVerified && !!bindToken && oaOk && !isBound;
    // }

    // function refreshSubmitState() {
    //   btnSubmit.disabled = !canSubmit();
    // }

    // function autofillNameFromLineProfile() {
    //   if (!liffProfile?.displayName) return;

    //   // å¦‚æœä½¿ç”¨è€…å·²è¼¸å…¥ï¼Œå°±ä¸è¦ç¡¬è¦†è“‹
    //   const current = (nameInput.value || "").trim();
    //   if (current.length > 0) return;

    //   nameInput.value = liffProfile.displayName.trim();
    //   dbg(`autofill name <- ${liffProfile.displayName}`);
    // }

    // ====== OA lookup ======
    async function lookupDbNameByOaId(oaidValue) {
      if (!oaidValue) {
        dbName = "ï¼ˆæœªæä¾› oaidï¼‰";
        dbg(`oaid missing -> db_name=${dbName}`);
        return;
      }
      try {
        const url = `${API_OA_LOOKUP}?oaid=${encodeURIComponent(oaidValue)}`;
        const res = await fetch(url, { method: "GET", mode: "cors", cache: "no-store" });
        const data = await res.json().catch(() => ({}));

        if (!res.ok || !data?.ok) {
          dbName = "ï¼ˆæŸ¥è©¢å¤±æ•—ï¼‰";
          dbg(`oa_lookup failed: HTTP ${res.status} / ${data?.error || "unknown"}`);
          return;
        }

        // ä½ å·²æ”¹å›å‚³æ ¼å¼ï¼šå¤–å±¤ db_name
        dbName = data?.db_name || "ï¼ˆæŸ¥ç„¡å°æ‡‰ï¼‰";
        dbg(`oa_lookup ok -> oaid=${oaidValue}, db_name=${dbName}`);
      } catch (e) {
        dbName = "ï¼ˆæŸ¥è©¢å¤±æ•—ï¼‰";
        dbg(`oa_lookup exception: ${e?.message || e}`);
      }
    }

    // ====== is_bind_member ======
    async function checkIsBindMember(oaidValue, uidValue) {
      const url = `${API_IS_BIND}?oaid=${encodeURIComponent(oaidValue)}&uid=${encodeURIComponent(uidValue)}`;
      const res = await fetch(url, { method: "GET", mode: "cors", cache: "no-store" });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data?.ok) return { ok:false, error:(data?.error || `HTTP ${res.status}`) };
      return data;
    }



    // ====== OTP (å…ˆæ±‚æœ‰) ======
    function resetOtp() {
      otpVerified = false;
      otpInput.value = "";
      setInline(otpSendStatus, "å°šæœªç™¼é€", "");
      setInline(otpVerifyStatus, "å°šæœªé©—è­‰", "");
      refreshSubmitState();
    }

    // ====== Main init ======
    async function initAll() {
      dbg("init start");

      // 1) oaid
      oaid = getOaIdFromUrl();
      dbg(`oaid=${oaid || "(empty)"}`);

      // 2) lookup db
      await lookupDbNameByOaId(oaid);

      // 3) init LIFF
      try {
        await liff.init({ liffId: LIFF_ID });
        liffReady = true;
        dbg("LIFFï¼šå·²åˆå§‹åŒ–");
      } catch (e) {
        dbg(`LIFF init failed: ${e?.message || e}`);
        setStatus("LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¢ºèª LIFF ID/ç¶²è·¯ç‹€æ…‹", "error");
        refreshSubmitState();
        return;
      }

      // 4) login check
      if (!liff.isLoggedIn()) {
        dbg("Lineï¼šæœªç™»å…¥ -> redirect login");
        setStatus("å°šæœªç™»å…¥ Lineï¼Œæº–å‚™è·³è½‰ç™»å…¥â€¦");
        liff.login();
        return;
      }
      dbg("Lineï¼šå·²ç™»å…¥");

      // 5) get profile
      try {
        liffProfile = await liff.getProfile();
        dbg(`profile ok: displayName=${liffProfile.displayName}, uid=${liffProfile.userId}`);
        autofillNameFromLineProfile();
        refreshSubmitState(); // å¡«å…¥å¾Œé †ä¾¿æ›´æ–°é€å‡ºæŒ‰éˆ•ç‹€æ…‹
      } catch (e) {
        dbg(`getProfile failed: ${e?.message || e}`);
        setStatus("å–å¾—ä½¿ç”¨è€…è³‡è¨Šå¤±æ•—", "error");
        refreshSubmitState();
        return;
      }

      // 6) check bind
      try {
        const data = await checkIsBindMember(oaid, liffProfile.userId);
        if (!data.ok) throw new Error(data.error || "is_bind_member not ok");

        isBound = !!data.is_bound;
        memberNo = data.member_no ?? null;
        bindId = data.bind_id ?? null;

        if (isBound) {
          dbg(`Bindï¼šå·²ç¶å®š (member_no=${memberNo ?? "null"}, bind_id=${bindId ?? "null"})`);
          setStatus("æ­¤å¸³è™Ÿå·²ç¶å®šæœƒå“¡ï¼Œè¡¨å–®å·²é–å®šã€‚", "success");
          lockAllUI();
        } else {
          dbg("Bindï¼šæœªç¶å®š");
          setStatus("");
        }
      } catch (e) {
        dbg(`is_bind_member failed: ${e?.message || e}`);
        setStatus("æŸ¥è©¢ç¶å®šç‹€æ…‹å¤±æ•—ï¼ˆè«‹ç¨å¾Œé‡è©¦ï¼‰", "error");
      }

      // 7) init captcha/otp
      resetCaptcha();
      resetOtp();

      // 8) wire input events
      [nameInput, phoneInput].forEach(el => el.addEventListener("input", refreshSubmitState));
      captchaInput.addEventListener("input", refreshSubmitState);
      otpInput.addEventListener("input", refreshSubmitState);

      refreshSubmitState();
      dbg("init done");
    }

    // ====== Events ======
    btnCaptchaRefresh.addEventListener("click", () => resetCaptcha());

    btnCaptchaVerify.addEventListener("click", () => {
      const v = (captchaInput.value || "").trim();
      if (v === captchaCode) {
        captchaVerified = true;
        dbg("CAPTCHAï¼šé©—è­‰æˆåŠŸ");
        setInline(captchaVerifyStatus, "é©—è­‰æˆåŠŸ", "ok");
      } else {
        captchaVerified = false;
        dbg(`CAPTCHAï¼šé©—è­‰å¤±æ•— (input=${v || "empty"})`);
        setInline(captchaVerifyStatus, "é©—è­‰å¤±æ•—", "bad");
        // å¯é¸ï¼šå¤±æ•—å°±æ›ä¸€å¼µï¼Œé™ä½æš´åŠ›å˜—è©¦
        resetCaptcha();
      }
      refreshSubmitState();
    });

    // å…¨åŸŸï¼šè¨˜éŒ„å¾Œç«¯å›å‚³çš„ otpï¼ˆæ¸¬è©¦æ·å¾‘ç”¨ï¼‰
    let lastOtp = null;

    btnOtpSend.addEventListener("click", async () => {
      setInline(otpSendStatus, "ç™¼é€ä¸­â€¦", "");
      dbg("OTPï¼šsend request...");
      console.log(oaid,normalizePhone(phoneInput.value))
      const lineOAID = (oaid || "").trim(); // ä½ åŸæœ¬å°±æœ‰ oaid
      const phone = normalizePhone(phoneInput.value);

      try {
        const url = new URL(`${API_OTP}/send`);
        url.searchParams.set("lineOAID", lineOAID);
        url.searchParams.set("phone", phone);

        const res = await fetch(url.toString(), { method: "GET", mode: "cors", cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        // å¯é¸ï¼šä½ æƒ³çœ‹å›å‚³å…§å®¹å°±è®€ json
        const data = await res.json();
        console.log("otp send resp:", data);
        lastOtp = data?.otp ?? null;
        
        setInline(otpSendStatus, "å·²ç™¼é€ï¼ˆå…ˆæ±‚æœ‰ï¼‰", "ok");
        dbg("OTPï¼šsend ok");
      } catch (e) {
        setInline(otpSendStatus, "ç™¼é€å¤±æ•—", "bad");
        dbg(`OTPï¼šsend failed: ${e?.message || e}`);
      }
    });

    btnOtpVerify.addEventListener("click", () => {
      // å…ˆæ±‚æœ‰ï¼šåªåšæ ¼å¼åˆ¤æ–·ï¼ˆä½ ä¹‹å¾Œæ¥å¾Œç«¯ verifyï¼‰
      const v = (otpInput.value || "").trim();
      console.log(lastOtp)

      // å…ˆæ±‚æœ‰ï¼šæ·å¾‘ç‰ˆ = å‰ç«¯æ¯”å° lastOtp
      if (/^\d{6}$/.test(v) && lastOtp && v === String(lastOtp)) {
        otpVerified = true;
        setInline(otpVerifyStatus, "é©—è­‰æˆåŠŸï¼ˆå…ˆæ±‚æœ‰ï¼‰", "ok");
        dbg("OTPï¼šverify ok (frontend shortcut)");
      } else {
        otpVerified = false;
        // é€™è£¡é †ä¾¿å€åˆ†åŸå› ï¼Œæ–¹ä¾¿ä½ æ¸¬
        if (!/^\d{6}$/.test(v)) {
          setInline(otpVerifyStatus, "é©—è­‰å¤±æ•—ï¼šéœ€ 6 ä½æ•¸å­—", "bad");
          dbg("OTPï¼šverify failed (need 6 digits)");
        } else if (!lastOtp) {
          setInline(otpVerifyStatus, "é©—è­‰å¤±æ•—ï¼šè«‹å…ˆå–å¾—é©—è­‰ç¢¼", "bad");
          dbg("OTPï¼šverify failed (no lastOtp)");
        } else {
          setInline(otpVerifyStatus, "é©—è­‰å¤±æ•—ï¼šé©—è­‰ç¢¼ä¸æ­£ç¢º", "bad");
          dbg("OTPï¼šverify failed (mismatch)");
        }
      }
      refreshSubmitState();
    });

    // form.addEventListener("submit", async (e) => {
    //   e.preventDefault();
    //   if (!canSubmit()) {
    //     dbg("submit blocked: canSubmit=false");
    //     setStatus("æ¢ä»¶å°šæœªå®Œæˆï¼Œç„¡æ³•é€å‡ºã€‚", "error");
    //     return;
    //   }

    //   const payload = {
    //     oaid,
    //     db_name: dbName,
    //     uid: liffProfile?.userId || "",
    //     displayName: liffProfile?.displayName || "",
    //     name: nameInput.value.trim(),
    //     phone: normalizePhone(phoneInput.value),
    //     address: addressInput.value.trim(),
    //     bind_token: bindToken,
    //     id_token: (window.liff?.getIDToken?.() || ""),
    //     access_token: (window.liff?.getAccessToken?.() || "")
    //   };

    //   dbg("submit payload:");
    //   dbg(JSON.stringify(payload));

    //   // TODO: æ¥å¾Œç«¯ç¶å®š API
    //   setStatus("é€å‡ºæµç¨‹å¾…æ¥å¾Œç«¯ç¶å®š APIï¼ˆç›®å‰åªè¼¸å‡º debug logï¼‰", "");
    // });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!canSubmit()) {
        dbg("submit blocked: canSubmit=false");
        setStatus("æ¢ä»¶å°šæœªå®Œæˆï¼Œç„¡æ³•é€å‡ºã€‚", "error");
        return;
      }

      // åªé€å››å€‹é‡è¦åƒæ•¸ï¼ˆå…ˆæ±‚æœ‰ï¼‰
const payload4 = {
  lineOAID: oaid,
  lineUid: liffProfile?.userId || "",
  name: nameInput.value.trim(),
  phone: normalizePhone(phoneInput.value),
};

try {
  setStatus("é€å‡ºä¸­â€¦", "");

  // GETï¼šæ”¹ç”¨ query string
  const url = new URL(`${API_BIND}/submit`); // ä¾‹ï¼šhttps://cwsoft.leaflune.org/bind/submit
  url.searchParams.set("lineOAID", payload4.lineOAID);
  url.searchParams.set("lineUid", payload4.lineUid);
  url.searchParams.set("name", payload4.name);
  url.searchParams.set("phone", payload4.phone);

  const res = await fetch(url.toString(), {
    method: "GET",
    mode: "cors",
    cache: "no-store",
  });

  // å¾Œç«¯å› json çš„è©±å°±è®€å‡ºä¾†æ–¹ä¾¿ debug
  const data = await res.json().catch(() => null);

  if (!res.ok) {
    dbg("bind failed resp:");
    dbg(JSON.stringify(data));
    throw new Error(`HTTP ${res.status}`);
  }

  dbg("bind ok resp:");
  dbg(JSON.stringify(data));
  setStatus("ç¶å®šé€å‡ºæˆåŠŸï¼ˆå…ˆæ±‚æœ‰ï¼‰", "ok");
} catch (err) {
  setStatus(`ç¶å®šé€å‡ºå¤±æ•—ï¼š${err?.message || err}`, "error");
}
    });

    // Boot
    initAll();
  </script>
</body>
</html>
